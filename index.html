<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System - Advanced Role-Based</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 40px;
            margin: 20px 0;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: bold;
        }

        h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 2em;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        input[type="number"], 
        input[type="file"],
        input[type="date"],
        select, 
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 18px;
            user-select: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 8px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
            color: #212529;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .role-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .role-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .role-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        }

        .role-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .role-availability {
            float: right;
            font-size: 12px;
            color: #666;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .dashboard-card:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .dashboard-card .card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .link-text {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .link-text:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        .alert {
            padding: 20px;
            margin: 25px 0;
            border-radius: 10px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-left: 5px solid #ffc107;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .page {
                padding: 25px;
            }

            .dashboard-card {
                padding: 30px 20px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 1000px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .controls-bar {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-fill.low {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .progress-fill.medium {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .progress-fill.high {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .user-role-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1001;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .filter-controls {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e1e5e9;
        }

        .fee-category-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .fee-category-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .exam-schedule-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .teacher-table-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .role-admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .role-dos-social {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .role-finance {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .role-dos-exam {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .role-teacher {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        }

        .access-denied {
            text-align: center;
            padding: 50px;
            color: #dc3545;
        }

        .feature-unavailable {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- User Role Badge -->
    <div id="user-role-badge" class="user-role-badge" style="display: none;">
        <span id="current-role">GUEST</span>
    </div>

    <div class="container">
        <!-- Welcome Page -->
        <div id="welcome-page" class="page active">
            <h1>🏫 Advanced School Management System</h1>
            <div style="text-align: center; margin: 40px 0;">
                <h2>Role-Based Access Control System</h2>
                <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                    Secure, comprehensive, and efficient school management with specialized roles and permissions.
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">5</div>
                    <div>User Roles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">∞</div>
                    <div>Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">100%</div>
                    <div>Secure</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">24/7</div>
                    <div>Available</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="showPage('login-page')">🔑 Login</button>
                <button class="btn btn-success" onclick="showPage('signup-page')">📝 Create Account</button>
            </div>

            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3>🎯 User Roles Available:</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>👑 Admin</strong><br>
                        <small>Complete system control (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>👥 DoS Social Affairs</strong><br>
                        <small>Student welfare & activities (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>💰 Finance</strong><br>
                        <small>Payment management (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>📊 DoS Exam</strong><br>
                        <small>Examination management (Unlimited)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>🎓 Teacher</strong><br>
                        <small>Classes & assessment (Unlimited)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sign Up Page -->
        <div id="signup-page" class="page">
            <h1>📝 Create Account</h1>
            
            <form id="signup-form">
                <!-- Personal Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-fullname">👤 Full Name</label>
                        <input type="text" id="signup-fullname" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="signup-username">🆔 Username</label>
                        <input type="text" id="signup-username" required placeholder="Choose unique username">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-email">📧 Email Address</label>
                        <input type="email" id="signup-email" required placeholder="Enter email address">
                    </div>
                    <div class="form-group">
                        <label for="signup-phone">📱 Phone Number</label>
                        <input type="text" id="signup-phone" required placeholder="Enter phone number">
                    </div>
                </div>

                <!-- Role Selection -->
                <div class="form-group">
                    <label>🎭 Select Your Role</label>
                    <div id="role-selection">
                        <div class="role-card" data-role="admin">
                            <h4>👑 Administrator</h4>
                            <p>Complete system access and control. Can manage all aspects of the school system.</p>
                            <div class="role-availability">
                                <span id="admin-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="dos_social">
                            <h4>👥 DoS Social Affairs</h4>
                            <p>Manage student welfare, social activities, sports fees, and uniform costs.</p>
                            <div class="role-availability">
                                <span id="dos-social-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="finance">
                            <h4>💰 Finance Officer</h4>
                            <p>Handle all financial aspects including fee collection, payment tracking, and financial reports.</p>
                            <div class="role-availability">
                                <span id="finance-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="dos_exam">
                            <h4>📊 DoS Examinations</h4>
                            <p>Manage examinations, schedules, and academic assessments.</p>
                            <div class="role-availability">
                                <span>Unlimited</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="teacher">
                            <h4>🎓 Teacher</h4>
                            <p>Conduct classes, manage students, create assessments and track performance.</p>
                            <div class="role-availability">
                                <span>Unlimited</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="signup-role" required>
                </div>

                <!-- Password -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-password">🔒 Password</label>
                        <div class="password-container">
                            <input type="password" id="signup-password" required placeholder="Strong password (min 6 chars)">
                            <span class="password-toggle" onclick="togglePassword('signup-password')">👁️</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-password">🔒 Confirm Password</label>
                        <div class="password-container">
                            <input type="password" id="signup-confirm-password" required placeholder="Confirm password">
                            <span class="password-toggle" onclick="togglePassword('signup-confirm-password')">👁️</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">✨ Create Account</button>
                    <br>
                    <a href="javascript:void(0)" onclick="showPage('login-page')" class="btn btn-secondary">🔑 Login Instead</a>
                    <a href="javascript:void(0)" onclick="showPage('welcome-page')" class="btn btn-secondary">⬅️ Back</a>
                </div>
            </form>
            <div id="signup-message"></div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page">
            <h1>🔑 Login</h1>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">👤 Username or Email</label>
                    <input type="text" id="login-username" required placeholder="Enter username or email">
                </div>
                <div class="form-group">
                    <label for="login-password">🔒 Password</label>
                    <div class="password-container">
                        <input type="password" id="login-password" required placeholder="Enter password">
                        <span class="password-toggle" onclick="togglePassword('login-password')">👁️</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn">🚀 Login</button>
                    <br>
                    <a href="javascript:void(0)" onclick="forgotPassword()" class="btn btn-warning">🤔 Forgot Password?</a>
                    <a href="javascript:void(0)" onclick="showPage('signup-page')" class="btn btn-secondary">📝 Create Account</a>
                    <a href="javascript:void(0)" onclick="showPage('welcome-page')" class="btn btn-secondary">⬅️ Back</a>
                </div>
            </form>
            <div id="login-message"></div>
        </div>

        <!-- Dashboard Pages for Different Roles -->
        
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="page">
            <h1>👑 Administrator Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="admin-welcome"></span>!</h2>
                <p>You have complete administrative control over the system</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-admin" onclick="showStudentManagement()">
                    <div class="card-icon">👥</div>
                    <h3>Student Management</h3>
                    <p>Add, edit, and manage all students</p>
                    <small id="admin-student-count">0 students</small>
                </div>

                <div class="dashboard-card role-finance" onclick="showFinancialManagement()">
                    <div class="card-icon">💰</div>
                    <h3>Financial Management</h3>
                    <p>Complete payment oversight</p>
                    <small id="admin-payment-overview">Total collected: $0</small>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamManagement()">
                    <div class="card-icon">📊</div>
                    <h3>Exam Management</h3>
                    <p>Oversee all examinations</p>
                    <small id="admin-exam-count">0 exams scheduled</small>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showSocialAffairs()">
                    <div class="card-icon">🎨</div>
                    <h3>Social Affairs</h3>
                    <p>Student welfare and activities</p>
                    <small>Sports & Uniforms</small>
                </div>

                <div class="dashboard-card role-teacher" onclick="showTeacherOverview()">
                    <div class="card-icon">🎓</div>
                    <h3>Teacher Overview</h3>
                    <p>Monitor teaching activities</p>
                    <small id="admin-teacher-count">0 active teachers</small>
                </div>

                <div class="dashboard-card" onclick="showSystemSettings()">
                    <div class="card-icon">⚙️</div>
                    <h3>System Settings</h3>
                    <p>Configure system parameters</p>
                    <small>User management & fees</small>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 My Profile</button>
                <button class="btn btn-warning" onclick="exportSystemData()">📥 Export All Data</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Finance Dashboard -->
        <div id="finance-dashboard" class="page">
            <h1>💰 Finance Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="finance-welcome"></span>!</h2>
                <p>Financial Management and Payment Tracking</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-revenue">$0</div>
                    <div>Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-payments">$0</div>
                    <div>Pending Payments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="collection-rate">0%</div>
                    <div>Collection Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overdue-accounts">0</div>
                    <div>Overdue Accounts</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-finance" onclick="showPaymentDashboard()">
                    <div class="card-icon">📋</div>
                    <h3>Payment Dashboard</h3>
                    <p>Track all fee payments</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFeeManagement()">
                    <div class="card-icon">💳</div>
                    <h3>Fee Management</h3>
                    <p>Manage fee categories</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFinancialReports()">
                    <div class="card-icon">📈</div>
                    <h3>Financial Reports</h3>
                    <p>Generate payment reports</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFeeReminders()">
                    <div class="card-icon">📧</div>
                    <h3>Fee Reminders</h3>
                    <p>Export reminder lists</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- DoS Social Affairs Dashboard -->
        <div id="dos-social-dashboard" class="page">
            <h1>👥 DoS Social Affairs Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="social-welcome"></span>!</h2>
                <p>Student Welfare and Social Activities Management</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-dos-social" onclick="showSportsManagement()">
                    <div class="card-icon">⚽</div>
                    <h3>Sports Management</h3>
                    <p>Sports fees and activities</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showUniformManagement()">
                    <div class="card-icon">👔</div>
                    <h3>Uniform Management</h3>
                    <p>Uniform fees and orders</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showStudentWelfare()">
                    <div class="card-icon">🤝</div>
                    <h3>Student Welfare</h3>
                    <p>Student support services</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showClubActivities()">
                    <div class="card-icon">🎭</div>
                    <h3>Club Activities</h3>
                    <p>Student clubs and societies</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- DoS Exam Dashboard -->
        <div id="dos-exam-dashboard" class="page">
            <h1>📊 DoS Examinations Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="exam-welcome"></span>!</h2>
                <p>Examination Management and Scheduling</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="upcoming-exams">0</div>
                    <div>Upcoming Exams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-exams">0</div>
                    <div>Completed Exams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-results">0</div>
                    <div>Pending Results</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-dos-exam" onclick="showExamSchedule()">
                    <div class="card-icon">📅</div>
                    <h3>Exam Schedule</h3>
                    <p>Create and manage schedules</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamCreation()">
                    <div class="card-icon">📝</div>
                    <h3>Create Exams</h3>
                    <p>Design new examinations</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showResultsManagement()">
                    <div class="card-icon">🎯</div>
                    <h3>Results Management</h3>
                    <p>Process and publish results</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamReports()">
                    <div class="card-icon">📈</div>
                    <h3>Exam Reports</h3>
                    <p>Generate performance reports</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="page">
            <h1>🎓 Teacher Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="teacher-welcome"></span>!</h2>
                <p>Teaching and Assessment Management</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="my-students">0</div>
                    <div>My Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="my-classes">0</div>
                    <div>Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-grades">0</div>
                    <div>Pending Grades</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-teacher" onclick="showMyStudents()">
                    <div class="card-icon">👥</div>
                    <h3>My Students</h3>
                    <p>View and manage students</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showMyExams()">
                    <div class="card-icon">📝</div>
                    <h3>My Exams</h3>
                    <p>Create and grade exams</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showRATs()">
                    <div class="card-icon">⚡</div>
                    <h3>R.A.Ts</h3>
                    <p>Random Assessment Tests</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showMyTable()">
                    <div class="card-icon">📋</div>
                    <h3>My Table</h3>
                    <p>Personal teaching schedule</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showClubManagement()">
                    <div class="card-icon">🏆</div>
                    <h3>Club Management</h3>
                    <p>Manage student clubs</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Payment Dashboard -->
        <div id="payment-dashboard" class="page">
            <h1>💰 Payment Management Dashboard</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddPaymentModal()">➕ Record Payment</button>
                <button class="btn btn-warning" onclick="exportFeeReminders()">📧 Fee Reminders</button>
                <button class="btn" onclick="showPaymentReports()">📊 Reports</button>
            </div>

            <div class="filter-controls">
                <h4>🔍 Filter Students</h4>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="payment-filter" onchange="filterPayments()">
                            <option value="all">All Students</option>
                            <option value="fully-paid">Fully Paid (100%)</option>
                            <option value="partial">Partially Paid (1-99%)</option>
                            <option value="unpaid">Unpaid (0%)</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Grade</label>
                        <select id="grade-filter" onchange="filterPayments()">
                            <option value="all">All Grades</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Term</label>
                        <select id="term-filter" onchange="filterPayments()">
                            <option value="current">Current Term</option>
                            <option value="1">Term 1</option>
                            <option value="2">Term 2</option>
                            <option value="3">Term 3</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Admission No.</th>
                            <th>Student Name</th>
                            <th>Grade</th>
                            <th>Total Fees</th>
                            <th>Amount Paid</th>
                            <th>Balance</th>
                            <th>Payment %</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payment-table-body">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 50px;">
                                <div class="loading"></div>
                                Loading payment data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Fee Management Page -->
        <div id="fee-management-page" class="page">
            <h1>💳 Fee Categories Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddFeeModal()" id="add-fee-btn">➕ Add Fee Category</button>
            </div>

            <div id="fee-categories-container">
                <!-- Fee categories will be loaded here -->
            </div>
        </div>

        <!-- Exam Management Page -->
        <div id="exam-management-page" class="page">
            <h1>📊 Examination Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showCreateExamModal()">➕ Create Exam</button>
                <button class="btn btn-warning" onclick="showExamScheduleModal()">📅 Schedule Exam</button>
            </div>

            <div id="exam-schedule-container">
                <!-- Exam schedules will be loaded here -->
            </div>
        </div>

        <!-- Student Management Page -->
        <div id="student-management-page" class="page">
            <h1>👥 Student Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddStudentModal()">➕ Add Student</button>
                <button class="btn" onclick="showBulkOperations()">⚙️ Bulk Operations</button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Filter by Grade</label>
                    <select id="student-grade-filter" onchange="filterStudents()">
                        <option value="all">All Grades</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                        <option value="9">Grade 9</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Search Students</label>
                    <input type="text" id="student-search" placeholder="Search by name or admission number" onkeyup="searchStudents()">
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Admission No.</th>
                            <th>Name</th>
                            <th>Gender</th>
                            <th>Age</th>
                            <th>Grade</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 50px;">
                                <div class="loading"></div>
                                Loading students...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Teacher Table Page -->
        <div id="teacher-table-page" class="page">
            <h1>📋 My Teaching Schedule</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="editTeacherTable()">✏️ Edit Schedule</button>
                <button class="btn btn-warning" onclick="exportTeacherTable()">📥 Export</button>
            </div>

            <div class="teacher-table-card">
                <h3>📅 Weekly Schedule</h3>
                <p style="color: #666; margin-bottom: 20px;">Your personalized teaching timetable (Feature under development)</p>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>8:00-9:00</strong></td>
                                <td>Math Grade 7</td>
                                <td>Science Grade 8</td>
                                <td>Math Grade 7</td>
                                <td>Science Grade 8</td>
                                <td>Free Period</td>
                            </tr>
                            <tr>
                                <td><strong>9:00-10:00</strong></td>
                                <td>Science Grade 9</td>
                                <td>Math Grade 9</td>
                                <td>Science Grade 9</td>
                                <td>Math Grade 9</td>
                                <td>Staff Meeting</td>
                            </tr>
                            <tr>
                                <td colspan="6" style="text-align: center; color: #666; font-style: italic;">
                                    Schedule customization coming soon...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="teacher-table-card">
                <h3>📝 Quick Notes</h3>
                <textarea id="teacher-notes" rows="5" placeholder="Add personal notes about your schedule, reminders, etc."></textarea>
                <button class="btn btn-success" onclick="saveTeacherNotes()" style="margin-top: 10px;">💾 Save Notes</button>
            </div>
        </div>

        <!-- Modals -->
        
        <!-- Add Student Modal -->
        <div id="add-student-modal" class="modal">
            <div class="modal-content">
                <h2>➕ Add New Student</h2>
                <form id="add-student-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="student-name">👤 Full Name</label>
                            <input type="text" id="student-name" required placeholder="Enter student's full name">
                        </div>
                        <div class="form-group">
                            <label for="student-adm">🎯 Admission Number</label>
                            <input type="text" id="student-adm" required placeholder="Enter unique admission number">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="student-gender">⚧ Gender</label>
                            <select id="student-gender" required>
                                <option value="">Select Gender</option>
                                <option value="M">👨 Male</option>
                                <option value="F">👩 Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-age">🎂 Age</label>
                            <input type="number" id="student-age" min="10" max="20" required placeholder="Age">
                        </div>
                        <div class="form-group">
                            <label for="student-grade">🎓 Grade</label>
                            <select id="student-grade" required>
                                <option value="">Select Grade</option>
                                <option value="7">📚 Grade 7</option>
                                <option value="8">📖 Grade 8</option>
                                <option value="9">📓 Grade 9</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="student-photo">📷 Student Photo (Optional)</label>
                        <input type="file" id="student-photo" accept="image/*">
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Add Student</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-student-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-student-message"></div>
            </div>
        </div>

        <!-- Add Payment Modal -->
        <div id="add-payment-modal" class="modal">
            <div class="modal-content">
                <h2>💰 Record Payment</h2>
                <form id="add-payment-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-student">👤 Student</label>
                            <select id="payment-student" required>
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payment-term">📅 Term</label>
                            <select id="payment-term" required>
                                <option value="1">Term 1</option>
                                <option value="2">Term 2</option>
                                <option value="3">Term 3</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="fee-categories-payment">
                        <!-- Fee categories will be loaded here -->
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-date">📅 Payment Date</label>
                            <input type="date" id="payment-date" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-method">💳 Payment Method</label>
                            <select id="payment-method" required>
                                <option value="Cash">💵 Cash</option>
                                <option value="Bank Transfer">🏦 Bank Transfer</option>
                                <option value="Mobile Money">📱 Mobile Money</option>
                                <option value="Cheque">📝 Cheque</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payment-notes">📝 Notes (Optional)</label>
                        <textarea id="payment-notes" rows="3" placeholder="Additional payment details"></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">💾 Record Payment</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-payment-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-payment-message"></div>
            </div>
        </div>

        <!-- Add Fee Category Modal -->
        <div id="add-fee-modal" class="modal">
            <div class="modal-content">
                <h2>💳 Add Fee Category</h2>
                <form id="add-fee-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fee-name">📝 Fee Name</label>
                            <input type="text" id="fee-name" required placeholder="e.g., Tuition Fee, Lunch Fee">
                        </div>
                        <div class="form-group">
                            <label for="fee-amount">💵 Amount per Term</label>
                            <input type="number" id="fee-amount" step="0.01" min="0" required placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fee-description">📋 Description</label>
                        <textarea id="fee-description" rows="3" placeholder="Description of this fee category"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fee-applies-to">🎯 Applies To</label>
                        <select id="fee-applies-to" required>
                            <option value="all">All Students</option>
                            <option value="grade7">Grade 7 Only</option>
                            <option value="grade8">Grade 8 Only</option>
                            <option value="grade9">Grade 9 Only</option>
                        </select>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Add Fee Category</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-fee-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-fee-message"></div>
            </div>
        </div>

        <!-- Create Exam Modal -->
        <div id="create-exam-modal" class="modal">
            <div class="modal-content">
                <h2>📝 Create New Exam</h2>
                <form id="create-exam-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-name">📋 Exam Name</label>
                            <input type="text" id="exam-name" required placeholder="e.g., Mid-term Exam 2024">
                        </div>
                        <div class="form-group">
                            <label for="exam-type">📊 Exam Type</label>
                            <select id="exam-type" required>
                                <option value="">Select Type</option>
                                <option value="Main Exam">📝 Main Exam</option>
                                <option value="R.A.T">⚡ R.A.T (Random Assessment Test)</option>
                                <option value="Assignment">📚 Assignment</option>
                                <option value="Project">🔬 Project</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-grade">🎓 Grade</label>
                            <select id="exam-grade" required>
                                <option value="">Select Grade</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exam-subject">📚 Subject</label>
                            <select id="exam-subject" required>
                                <option value="">Select Subject</option>
                                <option value="English">English</option>
                                <option value="Kiswahili">Kiswahili</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Integrated Science">Integrated Science</option>
                                <option value="Social Studies">Social Studies</option>
                                <option value="CRE">C.R.E</option>
                                <option value="Pre-technical Studies">Pre-technical Studies</option>
                                <option value="Agriculture">Agriculture</option>
                                <option value="Creative Arts">Creative Arts</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-date">📅 Exam Date</label>
                            <input type="date" id="exam-date" required>
                        </div>
                        <div class="form-group">
                            <label for="exam-duration">⏰ Duration (minutes)</label>
                            <input type="number" id="exam-duration" min="30" max="180" required placeholder="60">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="exam-instructions">📝 Instructions</label>
                        <textarea id="exam-instructions" rows="4" placeholder="Exam instructions for students"></textarea>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Create Exam</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('create-exam-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="create-exam-message"></div>
            </div>
        </div>

    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let systemData = {
            users: [],
            students: [],
            payments: [],
            exams: [],
            feeCategories: [
                { id: 'tuition', name: 'Tuition Fee', amount: 500, description: 'Main academic fee', appliesTo: 'all' },
                { id: 'lunch', name: 'Lunch Fee', amount: 150, description: 'School meals', appliesTo: 'all' },
                { id: 'transport', name: 'Transport Fee', amount: 100, description: 'School bus service', appliesTo: 'all' },
                { id: 'sports', name: 'Sports Fee', amount: 50, description: 'Sports activities and equipment', appliesTo: 'all' },
                { id: 'uniform', name: 'Uniform Fee', amount: 80, description: 'School uniform cost', appliesTo: 'all' },
                { id: 'library', name: 'Library Fee', amount: 30, description: 'Library resources and maintenance', appliesTo: 'all' }
            ],
            settings: {
                maxAdmins: 2,
                maxDoSSocial: 2,
                maxFinance: 2,
                currentAdmins: 0,
                currentDoSSocial: 0,
                currentFinance: 0
            }
        };

        // Role limits
        const ROLE_LIMITS = {
            admin: 2,
            dos_social: 2,
            finance: 2,
            dos_exam: -1, // unlimited
            teacher: -1   // unlimited
        };

        // ===== DATA PERSISTENCE SYSTEM =====
        
        class DataManager {
            constructor() {
                this.storageKey = 'sms_advanced_v1';
                this.init();
            }

            init() {
                this.loadData();
                this.updateRoleAvailability();
                this.setupAutoSave();
            }

            loadData() {
                const stored = localStorage.getItem(this.storageKey);
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        systemData = { ...systemData, ...data };
                        this.updateRoleCounts();
                    } catch (error) {
                        console.error('Error loading data:', error);
                    }
                }
            }

            saveData() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(systemData));
                    return true;
                } catch (error) {
                    console.error('Error saving data:', error);
                    return false;
                }
            }

            setupAutoSave() {
                // Auto-save every 30 seconds
                setInterval(() => {
                    this.saveData();
                }, 30000);

                // Save on page unload
                window.addEventListener('beforeunload', () => {
                    this.saveData();
                });
            }

            updateRoleCounts() {
                const users = systemData.users || [];
                systemData.settings.currentAdmins = users.filter(u => u.role === 'admin').length;
                systemData.settings.currentDoSSoc<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System - Advanced Role-Based</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 40px;
            margin: 20px 0;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: bold;
        }

        h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 2em;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        input[type="number"], 
        input[type="file"],
        input[type="date"],
        select, 
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 18px;
            user-select: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 8px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
            color: #212529;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .role-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .role-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .role-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        }

        .role-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .role-availability {
            float: right;
            font-size: 12px;
            color: #666;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .dashboard-card:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .dashboard-card .card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .link-text {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .link-text:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        .alert {
            padding: 20px;
            margin: 25px 0;
            border-radius: 10px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-left: 5px solid #ffc107;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .page {
                padding: 25px;
            }

            .dashboard-card {
                padding: 30px 20px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 1000px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .controls-bar {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-fill.low {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .progress-fill.medium {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .progress-fill.high {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .user-role-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1001;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .filter-controls {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e1e5e9;
        }

        .fee-category-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .fee-category-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .exam-schedule-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .teacher-table-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .role-admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .role-dos-social {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .role-finance {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .role-dos-exam {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .role-teacher {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        }

        .access-denied {
            text-align: center;
            padding: 50px;
            color: #dc3545;
        }

        .feature-unavailable {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- User Role Badge -->
    <div id="user-role-badge" class="user-role-badge" style="display: none;">
        <span id="current-role">GUEST</span>
    </div>

    <div class="container">
        <!-- Welcome Page -->
        <div id="welcome-page" class="page active">
            <h1>🏫 Advanced School Management System</h1>
            <div style="text-align: center; margin: 40px 0;">
                <h2>Role-Based Access Control System</h2>
                <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                    Secure, comprehensive, and efficient school management with specialized roles and permissions.
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">5</div>
                    <div>User Roles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">∞</div>
                    <div>Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">100%</div>
                    <div>Secure</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">24/7</div>
                    <div>Available</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="showPage('login-page')">🔑 Login</button>
                <button class="btn btn-success" onclick="showPage('signup-page')">📝 Create Account</button>
            </div>

            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3>🎯 User Roles Available:</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>👑 Admin</strong><br>
                        <small>Complete system control (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>👥 DoS Social Affairs</strong><br>
                        <small>Student welfare & activities (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>💰 Finance</strong><br>
                        <small>Payment management (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>📊 DoS Exam</strong><br>
                        <small>Examination management (Unlimited)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>🎓 Teacher</strong><br>
                        <small>Classes & assessment (Unlimited)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sign Up Page -->
        <div id="signup-page" class="page">
            <h1>📝 Create Account</h1>
            
            <form id="signup-form">
                <!-- Personal Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-fullname">👤 Full Name</label>
                        <input type="text" id="signup-fullname" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="signup-username">🆔 Username</label>
                        <input type="text" id="signup-username" required placeholder="Choose unique username">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-email">📧 Email Address</label>
                        <input type="email" id="signup-email" required placeholder="Enter email address">
                    </div>
                    <div class="form-group">
                        <label for="signup-phone">📱 Phone Number</label>
                        <input type="text" id="signup-phone" required placeholder="Enter phone number">
                    </div>
                </div>

                <!-- Role Selection -->
                <div class="form-group">
                    <label>🎭 Select Your Role</label>
                    <div id="role-selection">
                        <div class="role-card" data-role="admin">
                            <h4>👑 Administrator</h4>
                            <p>Complete system access and control. Can manage all aspects of the school system.</p>
                            <div class="role-availability">
                                <span id="admin-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="dos_social">
                            <h4>👥 DoS Social Affairs</h4>
                            <p>Manage student welfare, social activities, sports fees, and uniform costs.</p>
                            <div class="role-availability">
                                <span id="dos-social-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="finance">
                            <h4>💰 Finance Officer</h4>
                            <p>Handle all financial aspects including fee collection, payment tracking, and financial reports.</p>
                            <div class="role-availability">
                                <span id="finance-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="dos_exam">
                            <h4>📊 DoS Examinations</h4>
                            <p>Manage examinations, schedules, and academic assessments.</p>
                            <div class="role-availability">
                                <span>Unlimited</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="teacher">
                            <h4>🎓 Teacher</h4>
                            <p>Conduct classes, manage students, create assessments and track performance.</p>
                            <div class="role-availability">
                                <span>Unlimited</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="signup-role" required>
                </div>

                <!-- Password -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-password">🔒 Password</label>
                        <div class="password-container">
                            <input type="password" id="signup-password" required placeholder="Strong password (min 6 chars)">
                            <span class="password-toggle" onclick="togglePassword('signup-password')">👁️</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-password">🔒 Confirm Password</label>
                        <div class="password-container">
                            <input type="password" id="signup-confirm-password" required placeholder="Confirm password">
                            <span class="password-toggle" onclick="togglePassword('signup-confirm-password')">👁️</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">✨ Create Account</button>
                    <br>
                    <a href="javascript:void(0)" onclick="showPage('login-page')" class="btn btn-secondary">🔑 Login Instead</a>
                    <a href="javascript:void(0)" onclick="showPage('welcome-page')" class="btn btn-secondary">⬅️ Back</a>
                </div>
            </form>
            <div id="signup-message"></div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page">
            <h1>🔑 Login</h1>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">👤 Username or Email</label>
                    <input type="text" id="login-username" required placeholder="Enter username or email">
                </div>
                <div class="form-group">
                    <label for="login-password">🔒 Password</label>
                    <div class="password-container">
                        <input type="password" id="login-password" required placeholder="Enter password">
                        <span class="password-toggle" onclick="togglePassword('login-password')">👁️</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn">🚀 Login</button>
                    <br>
                    <a href="javascript:void(0)" onclick="forgotPassword()" class="btn btn-warning">🤔 Forgot Password?</a>
                    <a href="javascript:void(0)" onclick="showPage('signup-page')" class="btn btn-secondary">📝 Create Account</a>
                    <a href="javascript:void(0)" onclick="showPage('welcome-page')" class="btn btn-secondary">⬅️ Back</a>
                </div>
            </form>
            <div id="login-message"></div>
        </div>

        <!-- Dashboard Pages for Different Roles -->
        
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="page">
            <h1>👑 Administrator Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="admin-welcome"></span>!</h2>
                <p>You have complete administrative control over the system</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-admin" onclick="showStudentManagement()">
                    <div class="card-icon">👥</div>
                    <h3>Student Management</h3>
                    <p>Add, edit, and manage all students</p>
                    <small id="admin-student-count">0 students</small>
                </div>

                <div class="dashboard-card role-finance" onclick="showFinancialManagement()">
                    <div class="card-icon">💰</div>
                    <h3>Financial Management</h3>
                    <p>Complete payment oversight</p>
                    <small id="admin-payment-overview">Total collected: $0</small>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamManagement()">
                    <div class="card-icon">📊</div>
                    <h3>Exam Management</h3>
                    <p>Oversee all examinations</p>
                    <small id="admin-exam-count">0 exams scheduled</small>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showSocialAffairs()">
                    <div class="card-icon">🎨</div>
                    <h3>Social Affairs</h3>
                    <p>Student welfare and activities</p>
                    <small>Sports & Uniforms</small>
                </div>

                <div class="dashboard-card role-teacher" onclick="showTeacherOverview()">
                    <div class="card-icon">🎓</div>
                    <h3>Teacher Overview</h3>
                    <p>Monitor teaching activities</p>
                    <small id="admin-teacher-count">0 active teachers</small>
                </div>

                <div class="dashboard-card" onclick="showSystemSettings()">
                    <div class="card-icon">⚙️</div>
                    <h3>System Settings</h3>
                    <p>Configure system parameters</p>
                    <small>User management & fees</small>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 My Profile</button>
                <button class="btn btn-warning" onclick="exportSystemData()">📥 Export All Data</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Finance Dashboard -->
        <div id="finance-dashboard" class="page">
            <h1>💰 Finance Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="finance-welcome"></span>!</h2>
                <p>Financial Management and Payment Tracking</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-revenue">$0</div>
                    <div>Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-payments">$0</div>
                    <div>Pending Payments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="collection-rate">0%</div>
                    <div>Collection Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overdue-accounts">0</div>
                    <div>Overdue Accounts</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-finance" onclick="showPaymentDashboard()">
                    <div class="card-icon">📋</div>
                    <h3>Payment Dashboard</h3>
                    <p>Track all fee payments</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFeeManagement()">
                    <div class="card-icon">💳</div>
                    <h3>Fee Management</h3>


                    updateRoleCounts() {
                const users = systemData.users || [];
                systemData.settings.currentAdmins = users.filter(u => u.role === 'admin').length;
                systemData.settings.currentDoSSocial = users.filter(u => u.role === 'dos_social').length;
                systemData.settings.currentFinance = users.filter(u => u.role === 'finance').length;
            }

            updateRoleAvailability() {
                this.updateRoleCounts();
                
                // Update UI
                document.getElementById('admin-availability').textContent = 
                    `Available: ${ROLE_LIMITS.admin - systemData.settings.currentAdmins}/${ROLE_LIMITS.admin}`;
                document.getElementById('dos-social-availability').textContent = 
                    `Available: ${ROLE_LIMITS.dos_social - systemData.settings.currentDoSSocial}/${ROLE_LIMITS.dos_social}`;
                document.getElementById('finance-availability').textContent = 
                    `Available: ${ROLE_LIMITS.finance - systemData.settings.currentFinance}/${ROLE_LIMITS.finance}`;

                // Disable role cards if limits reached
                this.toggleRoleCard('admin', systemData.settings.currentAdmins < ROLE_LIMITS.admin);
                this.toggleRoleCard('dos_social', systemData.settings.currentDoSSocial < ROLE_LIMITS.dos_social);
                this.toggleRoleCard('finance', systemData.settings.currentFinance < ROLE_LIMITS.finance);
            }

            toggleRoleCard(role, available) {
                const card = document.querySelector(`[data-role="${role}"]`);
                if (card) {
                    if (available) {
                        card.classList.remove('feature-unavailable');
                    } else {
                        card.classList.add('feature-unavailable');
                    }
                }
            }

            checkRoleLimit(role) {
                this.updateRoleCounts();
                
                switch(role) {
                    case 'admin':
                        return systemData.settings.currentAdmins < ROLE_LIMITS.admin;
                    case 'dos_social':
                        return systemData.settings.currentDoSSocial < ROLE_LIMITS.dos_social;
                    case 'finance':
                        return systemData.settings.currentFinance < ROLE_LIMITS.finance;
                    default:
                        return true; // unlimited roles
                }
            }
        }

        // Initialize data manager
        const dataManager = new DataManager();

        // ===== AUTHENTICATION SYSTEM =====
        
        function initRoleSelection() {
            const roleCards = document.querySelectorAll('.role-card');
            const roleInput = document.getElementById('signup-role');

            roleCards.forEach(card => {
                card.addEventListener('click', function() {
                    const role = this.dataset.role;
                    
                    // Check if role is available
                    if (!dataManager.checkRoleLimit(role)) {
                        showMessage('signup-message', `❌ ${this.querySelector('h4').textContent} positions are full!`, false);
                        return;
                    }

                    // Remove selection from other cards
                    roleCards.forEach(c => c.classList.remove('selected'));
                    
                    // Select this card
                    this.classList.add('selected');
                    roleInput.value = role;
                });
            });
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const formData = {
                fullname: document.getElementById('signup-fullname').value.trim(),
                username: document.getElementById('signup-username').value.trim(),
                email: document.getElementById('signup-email').value.trim(),
                phone: document.getElementById('signup-phone').value.trim(),
                role: document.getElementById('signup-role').value,
                password: document.getElementById('signup-password').value,
                confirmPassword: document.getElementById('signup-confirm-password').value
            };

            // Validation
            if (!formData.role) {
                showMessage('signup-message', '❌ Please select a user role!', false);
                return;
            }

            if (formData.password !== formData.confirmPassword) {
                showMessage('signup-message', '❌ Passwords do not match!', false);
                return;
            }

            if (formData.password.length < 6) {
                showMessage('signup-message', '❌ Password must be at least 6 characters long!', false);
                return;
            }

            // Check role availability
            if (!dataManager.checkRoleLimit(formData.role)) {
                showMessage('signup-message', '❌ This role is no longer available!', false);
                return;
            }

            // Check for existing users
            const existingUser = systemData.users.find(u => 
                u.username === formData.username || 
                u.email === formData.email || 
                u.phone === formData.phone
            );

            if (existingUser) {
                showMessage('signup-message', '❌ Username, email, or phone already exists!', false);
                return;
            }

            // Create user
            const newUser = {
                id: generateId(),
                fullname: formData.fullname,
                username: formData.username,
                email: formData.email,
                phone: formData.phone,
                role: formData.role,
                password: hashPassword(formData.password),
                createdAt: new Date().toISOString(),
                status: 'active'
            };

            systemData.users.push(newUser);
            dataManager.saveData();
            dataManager.updateRoleAvailability();

            currentUser = { ...newUser };
            delete currentUser.password;

            showMessage('signup-message', '✅ Account created successfully! Welcome aboard!', true);

            setTimeout(() => {
                updateUserRoleBadge();
                showRoleDashboard();
            }, 1500);
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            const user = systemData.users.find(u => 
                (u.username === username || u.email === username) && 
                u.status === 'active'
            );

            if (!user || !verifyPassword(password, user.password)) {
                showMessage('login-message', '❌ Invalid credentials!', false);
                return;
            }

            currentUser = { ...user };
            delete currentUser.password;

            // Update last login
            user.lastLogin = new Date().toISOString();
            dataManager.saveData();

            updateUserRoleBadge();
            showRoleDashboard();
            
            document.getElementById('login-form').reset();
        }

        function showRoleDashboard() {
            const dashboards = {
                'admin': 'admin-dashboard',
                'dos_social': 'dos-social-dashboard',
                'finance': 'finance-dashboard',
                'dos_exam': 'dos-exam-dashboard',
                'teacher': 'teacher-dashboard'
            };

            const dashboardId = dashboards[currentUser.role];
            if (dashboardId) {
                updateDashboardData();
                showPage(dashboardId);
            }
        }

        function updateUserRoleBadge() {
            const badge = document.getElementById('user-role-badge');
            const roleText = document.getElementById('current-role');
            
            if (currentUser) {
                const roleNames = {
                    'admin': 'ADMIN',
                    'dos_social': 'DoS SOCIAL',
                    'finance': 'FINANCE',
                    'dos_exam': 'DoS EXAM',
                    'teacher': 'TEACHER'
                };
                
                roleText.textContent = roleNames[currentUser.role] || currentUser.role.toUpperCase();
                badge.style.display = 'block';
                badge.className = `user-role-badge role-${currentUser.role}`;
            } else {
                badge.style.display = 'none';
            }
        }

        function updateDashboardData() {
            if (!currentUser) return;

            // Update welcome messages
            const welcomeSpans = document.querySelectorAll(`#${currentUser.role}-welcome`);
            welcomeSpans.forEach(span => {
                if (span) span.textContent = currentUser.fullname;
            });

            // Update statistics based on role
            updateRoleSpecificStats();
        }

        function updateRoleSpecificStats() {
            const students = systemData.students || [];
            const payments = systemData.payments || [];
            const exams = systemData.exams || [];

            // Common stats
            document.querySelectorAll('[id$="-student-count"]').forEach(el => {
                el.textContent = `${students.length} students`;
            });

            // Role-specific updates
            switch(currentUser.role) {
                case 'finance':
                    updateFinanceStats(payments);
                    break;
                case 'dos_exam':
                    updateExamStats(exams);
                    break;
                case 'teacher':
                    updateTeacherStats(students, exams);
                    break;
            }
        }

        function updateFinanceStats(payments) {
            const totalRevenue = payments.reduce((sum, p) => sum + (p.totalAmount || 0), 0);
            const totalPaid = payments.reduce((sum, p) => sum + (p.paidAmount || 0), 0);
            const pending = totalRevenue - totalPaid;
            const collectionRate = totalRevenue > 0 ? Math.round((totalPaid / totalRevenue) * 100) : 0;
            
            const revenueEl = document.getElementById('total-revenue');
            const pendingEl = document.getElementById('pending-payments');
            const rateEl = document.getElementById('collection-rate');
            
            if (revenueEl) revenueEl.textContent = `${totalPaid.toFixed(2)}`;
            if (pendingEl) pendingEl.textContent = `${pending.toFixed(2)}`;
            if (rateEl) rateEl.textContent = `${collectionRate}%`;
        }

        function updateExamStats(exams) {
            const upcoming = exams.filter(e => new Date(e.date) > new Date()).length;
            const completed = exams.filter(e => new Date(e.date) <= new Date()).length;
            
            const upcomingEl = document.getElementById('upcoming-exams');
            const completedEl = document.getElementById('completed-exams');
            
            if (upcomingEl) upcomingEl.textContent = upcoming;
            if (completedEl) completedEl.textContent = completed;
        }

        function updateTeacherStats(students, exams) {
            // For now, show all students as "my students" for teachers
            const myStudentsEl = document.getElementById('my-students');
            const myClassesEl = document.getElementById('my-classes');
            
            if (myStudentsEl) myStudentsEl.textContent = students.length;
            if (myClassesEl) myClassesEl.textContent = '3'; // Sample data
        }

        // ===== PERMISSION SYSTEM =====
        
        function hasPermission(action) {
            if (!currentUser) return false;
            
            const permissions = {
                'admin': ['all'],
                'finance': ['view_payments', 'add_payment', 'edit_payment', 'manage_fees', 'financial_reports'],
                'dos_social': ['view_students', 'sports_fees', 'uniform_fees', 'social_activities'],
                'dos_exam': ['create_exam', 'schedule_exam', 'manage_results', 'exam_reports'],
                'teacher': ['view_students', 'create_exam', 'grade_exam', 'manage_rats', 'view_schedule']
            };

            const userPermissions = permissions[currentUser.role] || [];
            return userPermissions.includes('all') || userPermissions.includes(action);
        }

        function checkPermission(action) {
            if (!hasPermission(action)) {
                showMessage('general-message', '❌ You do not have permission to perform this action!', false);
                return false;
            }
            return true;
        }

        // ===== STUDENT MANAGEMENT =====
        
        function showStudentManagement() {
            if (!checkPermission('view_students') && !hasPermission('all')) return;
            
            loadStudentsTable();
            showPage('student-management-page');
        }

        function loadStudentsTable() {
            const tbody = document.getElementById('student-table-body');
            const students = systemData.students || [];
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 50px; color: #666;">
                            👥 No students registered yet
                            <br><br>
                            <button class="btn btn-success" onclick="showAddStudentModal()">➕ Add First Student</button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.admNo}</td>
                    <td><span class="link-text" onclick="viewStudentDetails('${student.id}')">${student.name}</span></td>
                    <td>${student.gender === 'M' ? '👨 Male' : '👩 Female'}</td>
                    <td>${student.age}</td>
                    <td>Grade ${student.grade}</td>
                    <td><span style="color: #28a745;">● Active</span></td>
                    <td>
                        <button class="btn" onclick="viewStudentDetails('${student.id}')">👁️ View</button>
                        ${hasPermission('all') ? `<button class="btn btn-danger" onclick="deleteStudent('${student.id}')">🗑️ Delete</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function showAddStudentModal() {
            if (!checkPermission('all') && !hasPermission('view_students')) return;
            
            document.getElementById('add-student-modal').classList.add('active');
        }

        async function handleAddStudent(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('student-name').value.trim(),
                admNo: document.getElementById('student-adm').value.trim(),
                gender: document.getElementById('student-gender').value,
                age: parseInt(document.getElementById('student-age').value),
                grade: parseInt(document.getElementById('student-grade').value)
            };

            // Validation
            if (systemData.students.find(s => s.admNo === formData.admNo)) {
                showMessage('add-student-message', '❌ Admission number already exists!', false);
                return;
            }

            // Handle photo
            const photoFile = document.getElementById('student-photo').files[0];
            let photoData = null;
            
            if (photoFile) {
                photoData = await fileToBase64(photoFile);
            }

            const newStudent = {
                id: generateId(),
                ...formData,
                photo: photoData,
                createdAt: new Date().toISOString(),
                status: 'active'
            };

            systemData.students.push(newStudent);
            dataManager.saveData();
            
            // Create initial payment record
            createStudentPaymentRecord(newStudent);

            showMessage('add-student-message', '✅ Student added successfully!', true);
            
            setTimeout(() => {
                closeModal('add-student-modal');
                loadStudentsTable();
                updateRoleSpecificStats();
            }, 1500);
        }

        function createStudentPaymentRecord(student) {
            const feeCategories = systemData.feeCategories || [];
            const applicableFees = feeCategories.filter(fee => 
                fee.appliesTo === 'all' || fee.appliesTo === `grade${student.grade}`
            );

            const totalFees = applicableFees.reduce((sum, fee) => sum + fee.amount, 0);

            const paymentRecord = {
                id: generateId(),
                studentId: student.id,
                admNo: student.admNo,
                studentName: student.name,
                grade: student.grade,
                totalFees: totalFees,
                paidAmount: 0,
                balance: totalFees,
                paymentPercentage: 0,
                paymentHistory: [],
                createdAt: new Date().toISOString()
            };

            systemData.payments = systemData.payments || [];
            systemData.payments.push(paymentRecord);
        }

        // ===== PAYMENT MANAGEMENT =====
        
        function showPaymentDashboard() {
            if (!checkPermission('view_payments') && !hasPermission('all')) return;
            
            loadPaymentTable();
            loadStudentOptionsForPayment();
            showPage('payment-dashboard');
        }

        function loadPaymentTable() {
            const tbody = document.getElementById('payment-table-body');
            const payments = systemData.payments || [];
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 50px; color: #666;">
                            💰 No payment records found
                            <br><br>
                            <button class="btn btn-success" onclick="showAddPaymentModal()">➕ Record First Payment</button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = payments.map(payment => {
                const percentage = payment.totalFees > 0 ? Math.round((payment.paidAmount / payment.totalFees) * 100) : 0;
                let statusColor = '#dc3545'; // red for unpaid
                let statusText = 'Unpaid';
                
                if (percentage === 100) {
                    statusColor = '#28a745'; // green for fully paid
                    statusText = 'Fully Paid';
                } else if (percentage > 0) {
                    statusColor = '#ffc107'; // yellow for partially paid
                    statusText = 'Partial';
                }

                return `
                    <tr>
                        <td>${payment.admNo}</td>
                        <td><span class="link-text" onclick="viewPaymentDetails('${payment.id}')">${payment.studentName}</span></td>
                        <td>Grade ${payment.grade}</td>
                        <td>${payment.totalFees.toFixed(2)}</td>
                        <td>${payment.paidAmount.toFixed(2)}</td>
                        <td>${payment.balance.toFixed(2)}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill ${percentage < 50 ? 'low' : percentage < 100 ? 'medium' : 'high'}" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            ${percentage}%
                        </td>
                        <td><span style="color: ${statusColor}">● ${statusText}</span></td>
                        <td>
                            <button class="btn" onclick="recordPayment('${payment.id}')">💰 Pay</button>
                            <button class="btn btn-warning" onclick="viewPaymentHistory('${payment.id}')">📋 History</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadStudentOptionsForPayment() {
            const select = document.getElementById('payment-student');
            const students = systemData.students || [];
            
            select.innerHTML = '<option value="">Select Student</option>' + 
                students.map(student => `
                    <option value="${student.id}">${student.name} (${student.admNo})</option>
                `).join('');
        }

        function showAddPaymentModal() {
            if (!checkPermission('add_payment') && !hasPermission('all')) return;
            
            loadFeeCategories();
            loadStudentOptionsForPayment();
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-payment-modal').classList.add('active');
        }

        function loadFeeCategories() {
            const container = document.getElementById('fee-categories-payment');
            const categories = systemData.feeCategories || [];
            
            container.innerHTML = categories.map(category => `
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="fee-${category.id}" value="${category.id}" style="margin-right: 10px;">
                        ${category.name} - ${category.amount.toFixed(2)}
                    </label>
                    <input type="number" id="amount-${category.id}" step="0.01" min="0" max="${category.amount}" 
                           placeholder="Amount to pay" style="margin-top: 5px;" disabled>
                </div>
            `).join('');

            // Add event listeners for checkboxes
            categories.forEach(category => {
                const checkbox = document.getElementById(`fee-${category.id}`);
                const amountInput = document.getElementById(`amount-${category.id}`);
                
                if (checkbox && amountInput) {
                    checkbox.addEventListener('change', function() {
                        amountInput.disabled = !this.checked;
                        if (this.checked) {
                            amountInput.value = category.amount;
                            amountInput.focus();
                        } else {
                            amountInput.value = '';
                        }
                    });
                }
            });
        }

        async function handleAddPayment(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('payment-student').value;
            const term = document.getElementById('payment-term').value;
            const paymentDate = document.getElementById('payment-date').value;
            const paymentMethod = document.getElementById('payment-method').value;
            const notes = document.getElementById('payment-notes').value;

            if (!studentId) {
                showMessage('add-payment-message', '❌ Please select a student!', false);
                return;
            }

            // Get selected fee categories and amounts
            const selectedFees = [];
            let totalPayment = 0;

            systemData.feeCategories.forEach(category => {
                const checkbox = document.getElementById(`fee-${category.id}`);
                const amountInput = document.getElementById(`amount-${category.id}`);
                
                if (checkbox && checkbox.checked && amountInput.value) {
                    const amount = parseFloat(amountInput.value);
                    selectedFees.push({
                        categoryId: category.id,
                        categoryName: category.name,
                        amount: amount
                    });
                    totalPayment += amount;
                }
            });

            if (selectedFees.length === 0) {
                showMessage('add-payment-message', '❌ Please select at least one fee category!', false);
                return;
            }

            // Find student payment record
            const paymentRecord = systemData.payments.find(p => p.studentId === studentId);
            if (!paymentRecord) {
                showMessage('add-payment-message', '❌ Payment record not found for this student!', false);
                return;
            }

            // Create payment entry
            const paymentEntry = {
                id: generateId(),
                date: paymentDate,
                term: term,
                method: paymentMethod,
                amount: totalPayment,
                fees: selectedFees,
                notes: notes,
                recordedBy: currentUser.fullname,
                createdAt: new Date().toISOString()
            };

            // Update payment record
            paymentRecord.paidAmount += totalPayment;
            paymentRecord.balance = paymentRecord.totalFees - paymentRecord.paidAmount;
            paymentRecord.paymentPercentage = paymentRecord.totalFees > 0 ? 
                Math.round((paymentRecord.paidAmount / paymentRecord.totalFees) * 100) : 0;
            paymentRecord.paymentHistory.push(paymentEntry);

            dataManager.saveData();

            showMessage('add-payment-message', '✅ Payment recorded successfully!', true);
            
            setTimeout(() => {
                closeModal('add-payment-modal');
                loadPaymentTable();
                updateRoleSpecificStats();
            }, 1500);
        }

        function exportFeeReminders() {
            if (!checkPermission('financial_reports') && !hasPermission('all')) return;
            
            const payments = systemData.payments || [];
            const overduePayments = payments.filter(p => p.balance > 0);
            
            if (overduePayments.length === 0) {
                alert('📊 Great news! No outstanding fees to export.');
                return;
            }

            // Prepare data for Excel
            const data = [
                ['Fee Reminder Report', '', '', '', '', ''],
                ['Generated on:', new Date().toLocaleDateString(), '', '', '', ''],
                ['', '', '', '', '', ''],
                ['Admission No.', 'Student Name', 'Grade', 'Total Fees', 'Amount Paid', 'Outstanding Balance', 'Payment %']
            ];

            overduePayments.forEach(payment => {
                data.push([
                    payment.admNo,
                    payment.studentName,
                    `Grade ${payment.grade}`,
                    payment.totalFees.toFixed(2),
                    payment.paidAmount.toFixed(2),
                    payment.balance.toFixed(2),
                    `${payment.paymentPercentage}%`
                ]);
            });

            // Create and download Excel file
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Style the header
            ws['A1'] = { v: 'Fee Reminder Report', s: { font: { bold: true, size: 16 } } };
            
            XLSX.utils.book_append_sheet(wb, ws, 'Fee Reminders');
            XLSX.writeFile(wb, `Fee_Reminders_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert(`📥 Fee reminder report exported! ${overduePayments.length} students with outstanding fees.`);
        }

        function filterPayments() {
            const statusFilter = document.getElementById('payment-filter').value;
            const gradeFilter = document.getElementById('grade-filter').value;
            
            let filteredPayments = systemData.payments || [];
            
            // Filter by payment status
            if (statusFilter !== 'all') {
                switch(statusFilter) {
                    case 'fully-paid':
                        filteredPayments = filteredPayments.filter(p => p.paymentPercentage === 100);
                        break;
                    case 'partial':
                        filteredPayments = filteredPayments.filter(p => p.paymentPercentage > 0 && p.paymentPercentage < 100);
                        break;
                    case 'unpaid':
                        filteredPayments = filteredPayments.filter(p => p.paymentPercentage === 0);
                        break;
                    case 'overdue':
                        filteredPayments = filteredPayments.filter(p => p.balance > 0);
                        break;
                }
            }
            
            // Filter by grade
            if (gradeFilter !== 'all') {
                filteredPayments = filteredPayments.filter(p => p.grade.toString() === gradeFilter);
            }
            
            // Update table with filtered data
            updatePaymentTable(filteredPayments);
        }

        function updatePaymentTable(payments) {
            const tbody = document.getElementById('payment-table-body');
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 50px; color: #666;">
                            🔍 No payments match the current filter criteria
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = payments.map(payment => {
                const percentage = payment.totalFees > 0 ? Math.round((payment.paidAmount / payment.totalFees) * 100) : 0;
                let statusColor = '#dc3545';
                let statusText = 'Unpaid';
                
                if (percentage === 100) {
                    statusColor = '#28a745';
                    statusText = 'Fully Paid';
                } else if (percentage > 0) {
                    statusColor = '#ffc107';
                    statusText = 'Partial';
                }

                return `
                    <tr>
                        <td>${payment.admNo}</td>
                        <td><span class="link-text" onclick="viewPaymentDetails('${payment.id}')">${payment.studentName}</span></td>
                        <td>Grade ${payment.grade}</td>
                        <td>${payment.totalFees.toFixed(2)}</td>
                        <td>${payment.paidAmount.toFixed(2)}</td>
                        <td>${payment.balance.toFixed(2)}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill ${percentage < 50 ? 'low' : percentage < 100 ? 'medium' : 'high'}" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            ${percentage}%
                        </td>
                        <td><span style="color: ${statusColor}">● ${statusText}</span></td>
                        <td>
                            <button class="btn" onclick="recordPayment('${payment.id}')">💰 Pay</button>
                            <button class="btn btn-warning" onclick="viewPaymentHistory('${payment.id}')">📋 History</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ===== FEE MANAGEMENT =====
        
        function showFeeManagement() {
            if (!checkPermission('manage_fees') && !hasPermission('all')) return;
            
            loadFeeCategories();
            showPage('fee-management-page');
        }

        function loadFeeCategoriesPage() {
            const container = document.getElementById('fee-categories-container');
            const categories = systemData.feeCategories || [];
            
            container.innerHTML = categories.map(category => `
                <div class="fee-category-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${category.name}</h4>
                            <p style="color: #666;">${category.description}</p>
                            <p><strong>Amount:</strong> ${category.amount.toFixed(2)} per term</p>
                            <p><strong>Applies to:</strong> ${category.appliesTo === 'all' ? 'All Students' : category.appliesTo}</p>
                        </div>
                        <div>
                            ${hasPermission('all') ? `
                                <button class="btn btn-warning" onclick="editFeeCategory('${category.id}')">✏️ Edit</button>
                                <button class="btn btn-danger" onclick="deleteFeeCategory('${category.i                <div class="dashboard-card role-finance" onclick="showFeeManagement()">
                    <div class="card-icon">💳</div>
                    <h3>Fee Management</h3>
                    <p>Manage fee categories</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFinancialReports()">
                    <div class="card-icon">📈</div>
                    <h3>Financial Reports</h3>
                    <p>Generate payment reports</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFeeReminders()">
                    <div class="card-icon">📧</div>
                    <h3>Fee Reminders</h3>
                    <p>Export reminder lists</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- DoS Social Affairs Dashboard -->
        <div id="dos-social-dashboard" class="page">
            <h1>👥 DoS Social Affairs Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="social-welcome"></span>!</h2>
                <p>Student Welfare and Social Activities Management</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-dos-social" onclick="showSportsManagement()">
                    <div class="card-icon">⚽</div>
                    <h3>Sports Management</h3>
                    <p>Sports fees and activities</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showUniformManagement()">
                    <div class="card-icon">👔</div>
                    <h3>Uniform Management</h3>
                    <p>Uniform fees and orders</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showStudentWelfare()">
                    <div class="card-icon">🤝</div>
                    <h3>Student Welfare</h3>
                    <p>Student support services</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showClubActivities()">
                    <div class="card-icon">🎭</div>
                    <h3>Club Activities</h3>
                    <p>Student clubs and societies</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- DoS Exam Dashboard -->
        <div id="dos-exam-dashboard" class="page">
            <h1>📊 DoS Examinations Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="exam-welcome"></span>!</h2>
                <p>Examination Management and Scheduling</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="upcoming-exams">0</div>
                    <div>Upcoming Exams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-exams">0</div>
                    <div>Completed Exams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-results">0</div>
                    <div>Pending Results</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-dos-exam" onclick="showExamSchedule()">
                    <div class="card-icon">📅</div>
                    <h3>Exam Schedule</h3>
                    <p>Create and manage schedules</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamCreation()">
                    <div class="card-icon">📝</div>
                    <h3>Create Exams</h3>
                    <p>Design new examinations</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showResultsManagement()">
                    <div class="card-icon">🎯</div>
                    <h3>Results Management</h3>
                    <p>Process and publish results</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamReports()">
                    <div class="card-icon">📈</div>
                    <h3>Exam Reports</h3>
                    <p>Generate performance reports</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="page">
            <h1>🎓 Teacher Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="teacher-welcome"></span>!</h2>
                <p>Teaching and Assessment Management</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="my-students">0</div>
                    <div>My Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="my-classes">0</div>
                    <div>Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-grades">0</div>
                    <div>Pending Grades</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-teacher" onclick="showMyStudents()">
                    <div class="card-icon">👥</div>
                    <h3>My Students</h3>
                    <p>View and manage students</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showMyExams()">
                    <div class="card-icon">📝</div>
                    <h3>My Exams</h3>
                    <p>Create and grade exams</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showRATs()">
                    <div class="card-icon">⚡</div>
                    <h3>R.A.Ts</h3>
                    <p>Random Assessment Tests</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showMyTable()">
                    <div class="card-icon">📋</div>
                    <h3>My Table</h3>
                    <p>Personal teaching schedule</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showClubManagement()">
                    <div class="card-icon">🏆</div>
                    <h3>Club Management</h3>
                    <p>Manage student clubs</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Payment Dashboard -->
        <div id="payment-dashboard" class="page">
            <h1>💰 Payment Management Dashboard</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddPaymentModal()">➕ Record Payment</button>
                <button class="btn btn-warning" onclick="exportFeeReminders()">📧 Fee Reminders</button>
                <button class="btn" onclick="showPaymentReports()">📊 Reports</button>
            </div>

            <div class="filter-controls">
                <h4>🔍 Filter Students</h4>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="payment-filter" onchange="filterPayments()">
                            <option value="all">All Students</option>
                            <option value="fully-paid">Fully Paid (100%)</option>
                            <option value="partial">Partially Paid (1-99%)</option>
                            <option value="unpaid">Unpaid (0%)</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Grade</label>
                        <select id="grade-filter" onchange="filterPayments()">
                            <option value="all">All Grades</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Term</label>
                        <select id="term-filter" onchange="filterPayments()">
                            <option value="current">Current Term</option>
                            <option value="1">Term 1</option>
                            <option value="2">Term 2</option>
                            <option value="3">Term 3</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Admission No.</th>
                            <th>Student Name</th>
                            <th>Grade</th>
                            <th>Total Fees</th>
                            <th>Amount Paid</th>
                            <th>Balance</th>
                            <th>Payment %</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payment-table-body">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 50px;">
                                <div class="loading"></div>
                                Loading payment data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Fee Management Page -->
        <div id="fee-management-page" class="page">
            <h1>💳 Fee Categories Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddFeeModal()" id="add-fee-btn">➕ Add Fee Category</button>
            </div>

            <div id="fee-categories-container">
                <!-- Fee categories will be loaded here -->
            </div>
        </div>

        <!-- Exam Management Page -->
        <div id="exam-management-page" class="page">
            <h1>📊 Examination Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showCreateExamModal()">➕ Create Exam</button>
                <button class="btn btn-warning" onclick="showExamScheduleModal()">📅 Schedule Exam</button>
            </div>

            <div id="exam-schedule-container">
                <!-- Exam schedules will be loaded here -->
            </div>
        </div>

        <!-- Student Management Page -->
        <div id="student-management-page" class="page">
            <h1>👥 Student Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddStudentModal()">➕ Add Student</button>
                <button class="btn" onclick="showBulkOperations()">⚙️ Bulk Operations</button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Filter by Grade</label>
                    <select id="student-grade-filter" onchange="filterStudents()">
                        <option value="all">All Grades</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                        <option value="9">Grade 9</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Search Students</label>
                    <input type="text" id="student-search" placeholder="Search by name or admission number" onkeyup="searchStudents()">
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Admission No.</th>
                            <th>Name</th>
                            <th>Gender</th>
                            <th>Age</th>
                            <th>Grade</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 50px;">
                                <div class="loading"></div>
                                Loading students...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Teacher Table Page -->
        <div id="teacher-table-page" class="page">
            <h1>📋 My Teaching Schedule</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="editTeacherTable()">✏️ Edit Schedule</button>
                <button class="btn btn-warning" onclick="exportTeacherTable()">📥 Export</button>
            </div>

            <div class="teacher-table-card">
                <h3>📅 Weekly Schedule</h3>
                <p style="color: #666; margin-bottom: 20px;">Your personalized teaching timetable (Feature under development)</p>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>8:00-9:00</strong></td>
                                <td>Math Grade 7</td>
                                <td>Science Grade 8</td>
                                <td>Math Grade 7</td>
                                <td>Science Grade 8</td>
                                <td>Free Period</td>
                            </tr>
                            <tr>
                                <td><strong>9:00-10:00</strong></td>
                                <td>Science Grade 9</td>
                                <td>Math Grade 9</td>
                                <td>Science Grade 9</td>
                                <td>Math Grade 9</td>
                                <td>Staff Meeting</td>
                            </tr>
                            <tr>
                                <td colspan="6" style="text-align: center; color: #666; font-style: italic;">
                                    Schedule customization coming soon...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="teacher-table-card">
                <h3>📝 Quick Notes</h3>
                <textarea id="teacher-notes" rows="5" placeholder="Add personal notes about your schedule, reminders, etc."></textarea>
                <button class="btn btn-success" onclick="saveTeacherNotes()" style="margin-top: 10px;">💾 Save Notes</button>
            </div>
        </div>

        <!-- Modals -->
        
        <!-- Add Student Modal -->
        <div id="add-student-modal" class="modal">
            <div class="modal-content">
                <h2>➕ Add New Student</h2>
                <form id="add-student-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="student-name">👤 Full Name</label>
                            <input type="text" id="student-name" required placeholder="Enter student's full name">
                        </div>
                        <div class="form-group">
                            <label for="student-adm">🎯 Admission Number</label>
                            <input type="text" id="student-adm" required placeholder="Enter unique admission number">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="student-gender">⚧ Gender</label>
                            <select id="student-gender" required>
                                <option value="">Select Gender</option>
                                <option value="M">👨 Male</option>
                                <option value="F">👩 Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-age">🎂 Age</label>
                            <input type="number" id="student-age" min="10" max="20" required placeholder="Age">
                        </div>
                        <div class="form-group">
                            <label for="student-grade">🎓 Grade</label>
                            <select id="student-grade" required>
                                <option value="">Select Grade</option>
                                <option value="7">📚 Grade 7</option>
                                <option value="8">📖 Grade 8</option>
                                <option value="9">📓 Grade 9</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="student-photo">📷 Student Photo (Optional)</label>
                        <input type="file" id="student-photo" accept="image/*">
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Add Student</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-student-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-student-message"></div>
            </div>
        </div>

        <!-- Add Payment Modal -->
        <div id="add-payment-modal" class="modal">
            <div class="modal-content">
                <h2>💰 Record Payment</h2>
                <form id="add-payment-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-student">👤 Student</label>
                            <select id="payment-student" required>
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payment-term">📅 Term</label>
                            <select id="payment-term" required>
                                <option value="1">Term 1</option>
                                <option value="2">Term 2</option>
                                <option value="3">Term 3</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="fee-categories-payment">
                        <!-- Fee categories will be loaded here -->
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-date">📅 Payment Date</label>
                            <input type="date" id="payment-date" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-method">💳 Payment Method</label>
                            <select id="payment-method" required>
                                <option value="Cash">💵 Cash</option>
                                <option value="Bank Transfer">🏦 Bank Transfer</option>
                                <option value="Mobile Money">📱 Mobile Money</option>
                                <option value="Cheque">📝 Cheque</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payment-notes">📝 Notes (Optional)</label>
                        <textarea id="payment-notes" rows="3" placeholder="Additional payment details"></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">💾 Record Payment</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-payment-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-payment-message"></div>
            </div>
        </div>

        <!-- Add Fee Category Modal -->
        <div id="add-fee-modal" class="modal">
            <div class="modal-content">
                <h2>💳 Add Fee Category</h2>
                <form id="add-fee-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fee-name">📝 Fee Name</label>
                            <input type="text" id="fee-name" required placeholder="e.g., Tuition Fee, Lunch Fee">
                        </div>
                        <div class="form-group">
                            <label for="fee-amount">💵 Amount per Term</label>
                            <input type="number" id="fee-amount" step="0.01" min="0" required placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fee-description">📋 Description</label>
                        <textarea id="fee-description" rows="3" placeholder="Description of this fee category"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fee-applies-to">🎯 Applies To</label>
                        <select id="fee-applies-to" required>
                            <option value="all">All Students</option>
                            <option value="grade7">Grade 7 Only</option>
                            <option value="grade8">Grade 8 Only</option>
                            <option value="grade9">Grade 9 Only</option>
                        </select>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Add Fee Category</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-fee-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-fee-message"></div>
            </div>
        </div>

        <!-- Create Exam Modal -->
        <div id="create-exam-modal" class="modal">
            <div class="modal-content">
                <h2>📝 Create New Exam</h2>
                <form id="create-exam-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-name">📋 Exam Name</label>
                            <input type="text" id="exam-name" required placeholder="e.g., Mid-term Exam 2024">
                        </div>
                        <div class="form-group">
                            <label for="exam-type">📊 Exam Type</label>
                            <select id="exam-type" required>
                                <option value="">Select Type</option>
                                <option value="Main Exam">📝 Main Exam</option>
                                <option value="R.A.T">⚡ R.A.T (Random Assessment Test)</option>
                                <option value="Assignment">📚 Assignment</option>
                                <option value="Project">🔬 Project</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-grade">🎓 Grade</label>
                            <select id="exam-grade" required>
                                <option value="">Select Grade</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exam-subject">📚 Subject</label>
                            <select id="exam-subject" required>
                                <option value="">Select Subject</option>
                                <option value="English">English</option>
                                <option value="Kiswahili">Kiswahili</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Integrated Science">Integrated Science</option>
                                <option value="Social Studies">Social Studies</option>
                                <option value="CRE">C.R.E</option>
                                <option value="Pre-technical Studies">Pre-technical Studies</option>
                                <option value="Agriculture">Agriculture</option>
                                <option value="Creative Arts">Creative Arts</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-date">📅 Exam Date</label>
                            <input type="date" id="exam-date" required>
                        </div>
                        <div class="form-group">
                            <label for="exam-duration">⏰ Duration (minutes)</label>
                            <input type="number" id="exam-duration" min="30" max="180" required placeholder="60">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="exam-instructions">📝 Instructions</label>
                        <textarea id="exam-instructions" rows="4" placeholder="Exam instructions for students"></textarea>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Create Exam</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('create-exam-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="create-exam-message"></div>
            </div>
        </div>

    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let systemData = {
            users: [],
            students: [],
            payments: [],
            exams: [],
            feeCategories: [
                { id: 'tuition', name: 'Tuition Fee', amount: 500, description: 'Main academic fee', appliesTo: 'all' },
                { id: 'lunch', name: 'Lunch Fee', amount: 150, description: 'School meals', appliesTo: 'all' },
                { id: 'transport', name: 'Transport Fee', amount: 100, description: 'School bus service', appliesTo: 'all' },
                { id: 'sports', name: 'Sports Fee', amount: 50, description: 'Sports activities and equipment', appliesTo: 'all' },
                { id: 'uniform', name: 'Uniform Fee', amount: 80, description: 'School uniform cost', appliesTo: 'all' },
                { id: 'library', name: 'Library Fee', amount: 30, description: 'Library resources and maintenance', appliesTo: 'all' }
            ],
            settings: {
                maxAdmins: 2,
                maxDoSSocial: 2,
                maxFinance: 2,
                currentAdmins: 0,
                currentDoSSocial: 0,
                currentFinance: 0
            }
        };

        // Role limits
        const ROLE_LIMITS = {
            admin: 2,
            dos_social: 2,
            finance: 2,
            dos_exam: -1, // unlimited
            teacher: -1   // unlimited
        };

        // ===== DATA PERSISTENCE SYSTEM =====
        
        class DataManager {
            constructor() {
                this.storageKey = 'sms_advanced_v1';
                this.init();
            }

            init() {
                this.loadData();
                this.updateRoleAvailability();
                this.setupAutoSave();
            }

            loadData() {
                const stored = localStorage.getItem(this.storageKey);
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        systemData = { ...systemData, ...data };
                        this.updateRoleCounts();
                    } catch (error) {
                        console.error('Error loading data:', error);
                    }
                }
            }

            saveData() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(systemData));
                    return true;
                } catch (error) {
                    console.error('Error saving data:', error);
                    return false;
                }
            }

            setupAutoSave() {
                // Auto-save every 30 seconds
                setInterval(() => {
                    this.saveData();
                }, 30000);

                // Save on page unload
                window.addEventListener('beforeunload', () => {
                    this.saveData();
                });
            }

            updateRoleCounts() {
                const users = systemData.users || [];
                systemData.settings.currentAdmins = users.filter(u => u.role === 'admin').length;
                systemData.settings.currentDoSSoc<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System - Advanced Role-Based</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 40px;
            margin: 20px 0;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: bold;
        }

        h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 2em;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        input[type="number"], 
        input[type="file"],
        input[type="date"],
        select, 
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 18px;
            user-select: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 8px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
            color: #212529;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .role-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .role-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .role-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        }

        .role-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .role-availability {
            float: right;
            font-size: 12px;
            color: #666;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .dashboard-card:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .dashboard-card .card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .link-text {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .link-text:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        .alert {
            padding: 20px;
            margin: 25px 0;
            border-radius: 10px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-left: 5px solid #ffc107;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .page {
                padding: 25px;
            }

            .dashboard-card {
                padding: 30px 20px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 1000px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .controls-bar {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-fill.low {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .progress-fill.medium {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .progress-fill.high {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .user-role-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1001;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .filter-controls {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e1e5e9;
        }

        .fee-category-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .fee-category-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .exam-schedule-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .teacher-table-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .role-admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .role-dos-social {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .role-finance {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .role-dos-exam {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .role-teacher {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        }

        .access-denied {
            text-align: center;
            padding: 50px;
            color: #dc3545;
        }

        .feature-unavailable {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- User Role Badge -->
    <div id="user-role-badge" class="user-role-badge" style="display: none;">
        <span id="current-role">GUEST</span>
    </div>

    <div class="container">
        <!-- Welcome Page -->
        <div id="welcome-page" class="page active">
            <h1>🏫 Advanced School Management System</h1>
            <div style="text-align: center; margin: 40px 0;">
                <h2>Role-Based Access Control System</h2>
                <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                    Secure, comprehensive, and efficient school management with specialized roles and permissions.
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">5</div>
                    <div>User Roles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">∞</div>
                    <div>Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">100%</div>
                    <div>Secure</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">24/7</div>
                    <div>Available</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="showPage('login-page')">🔑 Login</button>
                <button class="btn btn-success" onclick="showPage('signup-page')">📝 Create Account</button>
            </div>

            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3>🎯 User Roles Available:</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>👑 Admin</strong><br>
                        <small>Complete system control (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>👥 DoS Social Affairs</strong><br>
                        <small>Student welfare & activities (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>💰 Finance</strong><br>
                        <small>Payment management (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>📊 DoS Exam</strong><br>
                        <small>Examination management (Unlimited)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>🎓 Teacher</strong><br>
                        <small>Classes & assessment (Unlimited)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sign Up Page -->
        <div id="signup-page" class="page">
            <h1>📝 Create Account</h1>
            
            <form id="signup-form">
                <!-- Personal Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-fullname">👤 Full Name</label>
                        <input type="text" id="signup-fullname" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="signup-username">🆔 Username</label>
                        <input type="text" id="signup-username" required placeholder="Choose unique username">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-email">📧 Email Address</label>
                        <input type="email" id="signup-email" required placeholder="Enter email address">
                    </div>
                    <div class="form-group">
                        <label for="signup-phone">📱 Phone Number</label>
                        <input type="text" id="signup-phone" required placeholder="Enter phone number">
                    </div>
                </div>

                <!-- Role Selection -->
                <div class="form-group">
                    <label>🎭 Select Your Role</label>
                    <div id="role-selection">
                        <div class="role-card" data-role="admin">
                            <h4>👑 Administrator</h4>
                            <p>Complete system access and control. Can manage all aspects of the school system.</p>
                            <div class="role-availability">
                                <span id="admin-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="dos_social">
                            <h4>👥 DoS Social Affairs</h4>
                            <p>Manage student welfare, social activities, sports fees, and uniform costs.</p>
                            <div class="role-availability">
                                <span id="dos-social-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="finance">
                            <h4>💰 Finance Officer</h4>
                            <p>Handle all financial aspects including fee collection, payment tracking, and financial reports.</p>
                            <div class="role-availability">
                                <span id="finance-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="dos_exam">
                            <h4>📊 DoS Examinations</h4>
                            <p>Manage examinations, schedules, and academic assessments.</p>
                            <div class="role-availability">
                                <span>Unlimited</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="teacher">
                            <h4>🎓 Teacher</h4>
                            <p>Conduct classes, manage students, create assessments and track performance.</p>
                            <div class="role-availability">
                                <span>Unlimited</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="signup-role" required>
                </div>

                <!-- Password -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-password">🔒 Password</label>
                        <div class="password-container">
                            <input type="password" id="signup-password" required placeholder="Strong password (min 6 chars)">
                            <span class="password-toggle" onclick="togglePassword('signup-password')">👁️</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-password">🔒 Confirm Password</label>
                        <div class="password-container">
                            <input type="password" id="signup-confirm-password" required placeholder="Confirm password">
                            <span class="password-toggle" onclick="togglePassword('signup-confirm-password')">👁️</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">✨ Create Account</button>
                    <br>
                    <a href="javascript:void(0)" onclick="showPage('login-page')" class="btn btn-secondary">🔑 Login Instead</a>
                    <a href="javascript:void(0)" onclick="showPage('welcome-page')" class="btn btn-secondary">⬅️ Back</a>
                </div>
            </form>
            <div id="signup-message"></div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page">
            <h1>🔑 Login</h1>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">👤 Username or Email</label>
                    <input type="text" id="login-username" required placeholder="Enter username or email">
                </div>
                <div class="form-group">
                    <label for="login-password">🔒 Password</label>
                    <div class="password-container">
                        <input type="password" id="login-password" required placeholder="Enter password">
                        <span class="password-toggle" onclick="togglePassword('login-password')">👁️</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn">🚀 Login</button>
                    <br>
                    <a href="javascript:void(0)" onclick="forgotPassword()" class="btn btn-warning">🤔 Forgot Password?</a>
                    <a href="javascript:void(0)" onclick="showPage('signup-page')" class="btn btn-secondary">📝 Create Account</a>
                    <a href="javascript:void(0)" onclick="showPage('welcome-page')" class="btn btn-secondary">⬅️ Back</a>
                </div>
            </form>
            <div id="login-message"></div>
        </div>

        <!-- Dashboard Pages for Different Roles -->
        
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="page">
            <h1>👑 Administrator Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="admin-welcome"></span>!</h2>
                <p>You have complete administrative control over the system</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-admin" onclick="showStudentManagement()">
                    <div class="card-icon">👥</div>
                    <h3>Student Management</h3>
                    <p>Add, edit, and manage all students</p>
                    <small id="admin-student-count">0 students</small>
                </div>

                <div class="dashboard-card role-finance" onclick="showFinancialManagement()">
                    <div class="card-icon">💰</div>
                    <h3>Financial Management</h3>
                    <p>Complete payment oversight</p>
                    <small id="admin-payment-overview">Total collected: $0</small>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamManagement()">
                    <div class="card-icon">📊</div>
                    <h3>Exam Management</h3>
                    <p>Oversee all examinations</p>
                    <small id="admin-exam-count">0 exams scheduled</small>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showSocialAffairs()">
                    <div class="card-icon">🎨</div>
                    <h3>Social Affairs</h3>
                    <p>Student welfare and activities</p>
                    <small>Sports & Uniforms</small>
                </div>

                <div class="dashboard-card role-teacher" onclick="showTeacherOverview()">
                    <div class="card-icon">🎓</div>
                    <h3>Teacher Overview</h3>
                    <p>Monitor teaching activities</p>
                    <small id="admin-teacher-count">0 active teachers</small>
                </div>

                <div class="dashboard-card" onclick="showSystemSettings()">
                    <div class="card-icon">⚙️</div>
                    <h3>System Settings</h3>
                    <p>Configure system parameters</p>
                    <small>User management & fees</small>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 My Profile</button>
                <button class="btn btn-warning" onclick="exportSystemData()">📥 Export All Data</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Finance Dashboard -->
        <div id="finance-dashboard" class="page">
            <h1>💰 Finance Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="finance-welcome"></span>!</h2>
                <p>Financial Management and Payment Tracking</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-revenue">$0</div>
                    <div>Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-payments">$0</div>
                    <div>Pending Payments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="collection-rate">0%</div>
                    <div>Collection Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overdue-accounts">0</div>
                    <div>Overdue Accounts</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-finance" onclick="showPaymentDashboard()">
                    <div class="card-icon">📋</div>
                    <h3>Payment Dashboard</h3>
                    <p>Track all fee payments</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFeeManagement()">
                    <div class="card-icon">💳</div>
                    <h3>Fee Management</h3>


updateRoleCounts() {
                const users = systemData.users || [];
                systemData.settings.currentAdmins = users.filter(u => u.role === 'admin').length;
                systemData.settings.currentDoSSocial = users.filter(u => u.role === 'dos_social').length;
                systemData.settings.currentFinance = users.filter(u => u.role === 'finance').length;
            }

            updateRoleAvailability() {
                this.updateRoleCounts();
                
                // Update UI
                document.getElementById('admin-availability').textContent = 
                    `Available: ${ROLE_LIMITS.admin - systemData.settings.currentAdmins}/${ROLE_LIMITS.admin}`;
                document.getElementById('dos-social-availability').textContent = 
                    `Available: ${ROLE_LIMITS.dos_social - systemData.settings.currentDoSSocial}/${ROLE_LIMITS.dos_social}`;
                document.getElementById('finance-availability').textContent = 
                    `Available: ${ROLE_LIMITS.finance - systemData.settings.currentFinance}/${ROLE_LIMITS.finance}`;

                // Disable role cards if limits reached
                this.toggleRoleCard('admin', systemData.settings.currentAdmins < ROLE_LIMITS.admin);
                this.toggleRoleCard('dos_social', systemData.settings.currentDoSSocial < ROLE_LIMITS.dos_social);
                this.toggleRoleCard('finance', systemData.settings.currentFinance < ROLE_LIMITS.finance);
            }

            toggleRoleCard(role, available) {
                const card = document.querySelector(`[data-role="${role}"]`);
                if (card) {
                    if (available) {
                        card.classList.remove('feature-unavailable');
                    } else {
                        card.classList.add('feature-unavailable');
                    }
                }
            }

            checkRoleLimit(role) {
                this.updateRoleCounts();
                
                switch(role) {
                    case 'admin':
                        return systemData.settings.currentAdmins < ROLE_LIMITS.admin;
                    case 'dos_social':
                        return systemData.settings.currentDoSSocial < ROLE_LIMITS.dos_social;
                    case 'finance':
                        return systemData.settings.currentFinance < ROLE_LIMITS.finance;
                    default:
                        return true; // unlimited roles
                }
            }
        }

        // Initialize data manager
        const dataManager = new DataManager();

        // ===== AUTHENTICATION SYSTEM =====
        
        function initRoleSelection() {
            const roleCards = document.querySelectorAll('.role-card');
            const roleInput = document.getElementById('signup-role');

            roleCards.forEach(card => {
                card.addEventListener('click', function() {
                    const role = this.dataset.role;
                    
                    // Check if role is available
                    if (!dataManager.checkRoleLimit(role)) {
                        showMessage('signup-message', `❌ ${this.querySelector('h4').textContent} positions are full!`, false);
                        return;
                    }

                    // Remove selection from other cards
                    roleCards.forEach(c => c.classList.remove('selected'));
                    
                    // Select this card
                    this.classList.add('selected');
                    roleInput.value = role;
                });
            });
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const formData = {
                fullname: document.getElementById('signup-fullname').value.trim(),
                username: document.getElementById('signup-username').value.trim(),
                email: document.getElementById('signup-email').value.trim(),
                phone: document.getElementById('signup-phone').value.trim(),
                role: document.getElementById('signup-role').value,
                password: document.getElementById('signup-password').value,
                confirmPassword: document.getElementById('signup-confirm-password').value
            };

            // Validation
            if (!formData.role) {
                showMessage('signup-message', '❌ Please select a user role!', false);
                return;
            }

            if (formData.password !== formData.confirmPassword) {
                showMessage('signup-message', '❌ Passwords do not match!', false);
                return;
            }

            if (formData.password.length < 6) {
                showMessage('signup-message', '❌ Password must be at least 6 characters long!', false);
                return;
            }

            // Check role availability
            if (!dataManager.checkRoleLimit(formData.role)) {
                showMessage('signup-message', '❌ This role is no longer available!', false);
                return;
            }

            // Check for existing users
            const existingUser = systemData.users.find(u => 
                u.username === formData.username || 
                u.email === formData.email || 
                u.phone === formData.phone
            );

            if (existingUser) {
                showMessage('signup-message', '❌ Username, email, or phone already exists!', false);
                return;
            }

            // Create user
            const newUser = {
                id: generateId(),
                fullname: formData.fullname,
                username: formData.username,
                email: formData.email,
                phone: formData.phone,
                role: formData.role,
                password: hashPassword(formData.password),
                createdAt: new Date().toISOString(),
                status: 'active'
            };

            systemData.users.push(newUser);
            dataManager.saveData();
            dataManager.updateRoleAvailability();

            currentUser = { ...newUser };
            delete currentUser.password;

            showMessage('signup-message', '✅ Account created successfully! Welcome aboard!', true);

            setTimeout(() => {
                updateUserRoleBadge();
                showRoleDashboard();
            }, 1500);
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            const user = systemData.users.find(u => 
                (u.username === username || u.email === username) && 
                u.status === 'active'
            );

            if (!user || !verifyPassword(password, user.password)) {
                showMessage('login-message', '❌ Invalid credentials!', false);
                return;
            }

            currentUser = { ...user };
            delete currentUser.password;

            // Update last login
            user.lastLogin = new Date().toISOString();
            dataManager.saveData();

            updateUserRoleBadge();
            showRoleDashboard();
            
            document.getElementById('login-form').reset();
        }

        function showRoleDashboard() {
            const dashboards = {
                'admin': 'admin-dashboard',
                'dos_social': 'dos-social-dashboard',
                'finance': 'finance-dashboard',
                'dos_exam': 'dos-exam-dashboard',
                'teacher': 'teacher-dashboard'
            };

            const dashboardId = dashboards[currentUser.role];
            if (dashboardId) {
                updateDashboardData();
                showPage(dashboardId);
            }
        }

        function updateUserRoleBadge() {
            const badge = document.getElementById('user-role-badge');
            const roleText = document.getElementById('current-role');
            
            if (currentUser) {
                const roleNames = {
                    'admin': 'ADMIN',
                    'dos_social': 'DoS SOCIAL',
                    'finance': 'FINANCE',
                    'dos_exam': 'DoS EXAM',
                    'teacher': 'TEACHER'
                };
                
                roleText.textContent = roleNames[currentUser.role] || currentUser.role.toUpperCase();
                badge.style.display = 'block';
                badge.className = `user-role-badge role-${currentUser.role}`;
            } else {
                badge.style.display = 'none';
            }
        }

        function updateDashboardData() {
            if (!currentUser) return;

            // Update welcome messages
            const welcomeSpans = document.querySelectorAll(`#${currentUser.role}-welcome`);
            welcomeSpans.forEach(span => {
                if (span) span.textContent = currentUser.fullname;
            });

            // Update statistics based on role
            updateRoleSpecificStats();
        }

        function updateRoleSpecificStats() {
            const students = systemData.students || [];
            const payments = systemData.payments || [];
            const exams = systemData.exams || [];

            // Common stats
            document.querySelectorAll('[id$="-student-count"]').forEach(el => {
                el.textContent = `${students.length} students`;
            });

            // Role-specific updates
            switch(currentUser.role) {
                case 'finance':
                    updateFinanceStats(payments);
                    break;
                case 'dos_exam':
                    updateExamStats(exams);
                    break;
                case 'teacher':
                    updateTeacherStats(students, exams);
                    break;
            }
        }

        function updateFinanceStats(payments) {
            const totalRevenue = payments.reduce((sum, p) => sum + (p.totalAmount || 0), 0);
            const totalPaid = payments.reduce((sum, p) => sum + (p.paidAmount || 0), 0);
            const pending = totalRevenue - totalPaid;
            const collectionRate = totalRevenue > 0 ? Math.round((totalPaid / totalRevenue) * 100) : 0;
            
            const revenueEl = document.getElementById('total-revenue');
            const pendingEl = document.getElementById('pending-payments');
            const rateEl = document.getElementById('collection-rate');
            
            if (revenueEl) revenueEl.textContent = `${totalPaid.toFixed(2)}`;
            if (pendingEl) pendingEl.textContent = `${pending.toFixed(2)}`;
            if (rateEl) rateEl.textContent = `${collectionRate}%`;
        }

        function updateExamStats(exams) {
            const upcoming = exams.filter(e => new Date(e.date) > new Date()).length;
            const completed = exams.filter(e => new Date(e.date) <= new Date()).length;
            
            const upcomingEl = document.getElementById('upcoming-exams');
            const completedEl = document.getElementById('completed-exams');
            
            if (upcomingEl) upcomingEl.textContent = upcoming;
            if (completedEl) completedEl.textContent = completed;
        }

        function updateTeacherStats(students, exams) {
            // For now, show all students as "my students" for teachers
            const myStudentsEl = document.getElementById('my-students');
            const myClassesEl = document.getElementById('my-classes');
            
            if (myStudentsEl) myStudentsEl.textContent = students.length;
            if (myClassesEl) myClassesEl.textContent = '3'; // Sample data
        }

        // ===== PERMISSION SYSTEM =====
        
        function hasPermission(action) {
            if (!currentUser) return false;
            
            const permissions = {
                'admin': ['all'],
                'finance': ['view_payments', 'add_payment', 'edit_payment', 'manage_fees', 'financial_reports'],
                'dos_social': ['view_students', 'sports_fees', 'uniform_fees', 'social_activities'],
                'dos_exam': ['create_exam', 'schedule_exam', 'manage_results', 'exam_reports'],
                'teacher': ['view_students', 'create_exam', 'grade_exam', 'manage_rats', 'view_schedule']
            };

            const userPermissions = permissions[currentUser.role] || [];
            return userPermissions.includes('all') || userPermissions.includes(action);
        }

        function checkPermission(action) {
            if (!hasPermission(action)) {
                showMessage('general-message', '❌ You do not have permission to perform this action!', false);
                return false;
            }
            return true;
        }

        // ===== STUDENT MANAGEMENT =====
        
        function showStudentManagement() {
            if (!checkPermission('view_students') && !hasPermission('all')) return;
            
            loadStudentsTable();
            showPage('student-management-page');
        }

        function loadStudentsTable() {
            const tbody = document.getElementById('student-table-body');
            const students = systemData.students || [];
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 50px; color: #666;">
                            👥 No students registered yet
                            <br><br>
                            <button class="btn btn-success" onclick="showAddStudentModal()">➕ Add First Student</button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.admNo}</td>
                    <td><span class="link-text" onclick="viewStudentDetails('${student.id}')">${student.name}</span></td>
                    <td>${student.gender === 'M' ? '👨 Male' : '👩 Female'}</td>
                    <td>${student.age}</td>
                    <td>Grade ${student.grade}</td>
                    <td><span style="color: #28a745;">● Active</span></td>
                    <td>
                        <button class="btn" onclick="viewStudentDetails('${student.id}')">👁️ View</button>
                        ${hasPermission('all') ? `<button class="btn btn-danger" onclick="deleteStudent('${student.id}')">🗑️ Delete</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function showAddStudentModal() {
            if (!checkPermission('all') && !hasPermission('view_students')) return;
            
            document.getElementById('add-student-modal').classList.add('active');
        }

        async function handleAddStudent(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('student-name').value.trim(),
                admNo: document.getElementById('student-adm').value.trim(),
                gender: document.getElementById('student-gender').value,
                age: parseInt(document.getElementById('student-age').value),
                grade: parseInt(document.getElementById('student-grade').value)
            };

            // Validation
            if (systemData.students.find(s => s.admNo === formData.admNo)) {
                showMessage('add-student-message', '❌ Admission number already exists!', false);
                return;
            }

            // Handle photo
            const photoFile = document.getElementById('student-photo').files[0];
            let photoData = null;
            
            if (photoFile) {
                photoData = await fileToBase64(photoFile);
            }

            const newStudent = {
                id: generateId(),
                ...formData,
                photo: photoData,
                createdAt: new Date().toISOString(),
                status: 'active'
            };

            systemData.students.push(newStudent);
            dataManager.saveData();
            
            // Create initial payment record
            createStudentPaymentRecord(newStudent);

            showMessage('add-student-message', '✅ Student added successfully!', true);
            
            setTimeout(() => {
                closeModal('add-student-modal');
                loadStudentsTable();
                updateRoleSpecificStats();
            }, 1500);
        }

        function createStudentPaymentRecord(student) {
            const feeCategories = systemData.feeCategories || [];
            const applicableFees = feeCategories.filter(fee => 
                fee.appliesTo === 'all' || fee.appliesTo === `grade${student.grade}`
            );

            const totalFees = applicableFees.reduce((sum, fee) => sum + fee.amount, 0);

            const paymentRecord = {
                id: generateId(),
                studentId: student.id,
                admNo: student.admNo,
                studentName: student.name,
                grade: student.grade,
                totalFees: totalFees,
                paidAmount: 0,
                balance: totalFees,
                paymentPercentage: 0,
                paymentHistory: [],
                createdAt: new Date().toISOString()
            };

            systemData.payments = systemData.payments || [];
            systemData.payments.push(paymentRecord);
        }

        // ===== PAYMENT MANAGEMENT =====
        
        function showPaymentDashboard() {
            if (!checkPermission('view_payments') && !hasPermission('all')) return;
            
            loadPaymentTable();
            loadStudentOptionsForPayment();
            showPage('payment-dashboard');
        }

        function loadPaymentTable() {
            const tbody = document.getElementById('payment-table-body');
            const payments = systemData.payments || [];
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 50px; color: #666;">
                            💰 No payment records found
                            <br><br>
                            <button class="btn btn-success" onclick="showAddPaymentModal()">➕ Record First Payment</button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = payments.map(payment => {
                const percentage = payment.totalFees > 0 ? Math.round((payment.paidAmount / payment.totalFees) * 100) : 0;
                let statusColor = '#dc3545'; // red for unpaid
                let statusText = 'Unpaid';
                
                if (percentage === 100) {
                    statusColor = '#28a745'; // green for fully paid
                    statusText = 'Fully Paid';
                } else if (percentage > 0) {
                    statusColor = '#ffc107'; // yellow for partially paid
                    statusText = 'Partial';
                }

                return `
                    <tr>
                        <td>${payment.admNo}</td>
                        <td><span class="link-text" onclick="viewPaymentDetails('${payment.id}')">${payment.studentName}</span></td>
                        <td>Grade ${payment.grade}</td>
                        <td>${payment.totalFees.toFixed(2)}</td>
                        <td>${payment.paidAmount.toFixed(2)}</td>
                        <td>${payment.balance.toFixed(2)}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill ${percentage < 50 ? 'low' : percentage < 100 ? 'medium' : 'high'}" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            ${percentage}%
                        </td>
                        <td><span style="color: ${statusColor}">● ${statusText}</span></td>
                        <td>
                            <button class="btn" onclick="recordPayment('${payment.id}')">💰 Pay</button>
                            <button class="btn btn-warning" onclick="viewPaymentHistory('${payment.id}')">📋 History</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadStudentOptionsForPayment() {
            const select = document.getElementById('payment-student');
            const students = systemData.students || [];
            
            select.innerHTML = '<option value="">Select Student</option>' + 
                students.map(student => `
                    <option value="${student.id}">${student.name} (${student.admNo})</option>
                `).join('');
        }

        function showAddPaymentModal() {
            if (!checkPermission('add_payment') && !hasPermission('all')) return;
            
            loadFeeCategories();
            loadStudentOptionsForPayment();
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-payment-modal').classList.add('active');
        }

        function loadFeeCategories() {
            const container = document.getElementById('fee-categories-payment');
            const categories = systemData.feeCategories || [];
            
            container.innerHTML = categories.map(category => `
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="fee-${category.id}" value="${category.id}" style="margin-right: 10px;">
                        ${category.name} - ${category.amount.toFixed(2)}
                    </label>
                    <input type="number" id="amount-${category.id}" step="0.01" min="0" max="${category.amount}" 
                           placeholder="Amount to pay" style="margin-top: 5px;" disabled>
                </div>
            `).join('');

            // Add event listeners for checkboxes
            categories.forEach(category => {
                const checkbox = document.getElementById(`fee-${category.id}`);
                const amountInput = document.getElementById(`amount-${category.id}`);
                
                if (checkbox && amountInput) {
                    checkbox.addEventListener('change', function() {
                        amountInput.disabled = !this.checked;
                        if (this.checked) {
                            amountInput.value = category.amount;
                            amountInput.focus();
                        } else {
                            amountInput.value = '';
                        }
                    });
                }
            });
        }

        async function handleAddPayment(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('payment-student').value;
            const term = document.getElementById('payment-term').value;
            const paymentDate = document.getElementById('payment-date').value;
            const paymentMethod = document.getElementById('payment-method').value;
            const notes = document.getElementById('payment-notes').value;

            if (!studentId) {
                showMessage('add-payment-message', '❌ Please select a student!', false);
                return;
            }

            // Get selected fee categories and amounts
            const selectedFees = [];
            let totalPayment = 0;

            systemData.feeCategories.forEach(category => {
                const checkbox = document.getElementById(`fee-${category.id}`);
                const amountInput = document.getElementById(`amount-${category.id}`);
                
                if (checkbox && checkbox.checked && amountInput.value) {
                    const amount = parseFloat(amountInput.value);
                    selectedFees.push({
                        categoryId: category.id,
                        categoryName: category.name,
                        amount: amount
                    });
                    totalPayment += amount;
                }
            });

            if (selectedFees.length === 0) {
                showMessage('add-payment-message', '❌ Please select at least one fee category!', false);
                return;
            }

            // Find student payment record
            const paymentRecord = systemData.payments.find(p => p.studentId === studentId);
            if (!paymentRecord) {
                showMessage('add-payment-message', '❌ Payment record not found for this student!', false);
                return;
            }

            // Create payment entry
            const paymentEntry = {
                id: generateId(),
                date: paymentDate,
                term: term,
                method: paymentMethod,
                amount: totalPayment,
                fees: selectedFees,
                notes: notes,
                recordedBy: currentUser.fullname,
                createdAt: new Date().toISOString()
            };

            // Update payment record
            paymentRecord.paidAmount += totalPayment;
            paymentRecord.balance = paymentRecord.totalFees - paymentRecord.paidAmount;
            paymentRecord.paymentPercentage = paymentRecord.totalFees > 0 ? 
                Math.round((paymentRecord.paidAmount / paymentRecord.totalFees) * 100) : 0;
            paymentRecord.paymentHistory.push(paymentEntry);

            dataManager.saveData();

            showMessage('add-payment-message', '✅ Payment recorded successfully!', true);
            
            setTimeout(() => {
                closeModal('add-payment-modal');
                loadPaymentTable();
                updateRoleSpecificStats();
            }, 1500);
        }

        function exportFeeReminders() {
            if (!checkPermission('financial_reports') && !hasPermission('all')) return;
            
            const payments = systemData.payments || [];
            const overduePayments = payments.filter(p => p.balance > 0);
            
            if (overduePayments.length === 0) {
                alert('📊 Great news! No outstanding fees to export.');
                return;
            }

            // Prepare data for Excel
            const data = [
                ['Fee Reminder Report', '', '', '', '', ''],
                ['Generated on:', new Date().toLocaleDateString(), '', '', '', ''],
                ['', '', '', '', '', ''],
                ['Admission No.', 'Student Name', 'Grade', 'Total Fees', 'Amount Paid', 'Outstanding Balance', 'Payment %']
            ];

            overduePayments.forEach(payment => {
                data.push([
                    payment.admNo,
                    payment.studentName,
                    `Grade ${payment.grade}`,
                    payment.totalFees.toFixed(2),
                    payment.paidAmount.toFixed(2),
                    payment.balance.toFixed(2),
                    `${payment.paymentPercentage}%`
                ]);
            });

            // Create and download Excel file
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Style the header
            ws['A1'] = { v: 'Fee Reminder Report', s: { font: { bold: true, size: 16 } } };
            
            XLSX.utils.book_append_sheet(wb, ws, 'Fee Reminders');
            XLSX.writeFile(wb, `Fee_Reminders_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert(`📥 Fee reminder report exported! ${overduePayments.length} students with outstanding fees.`);
        }

        function filterPayments() {
            const statusFilter = document.getElementById('payment-filter').value;
            const gradeFilter = document.getElementById('grade-filter').value;
            
            let filteredPayments = systemData.payments || [];
            
            // Filter by payment status
            if (statusFilter !== 'all') {
                switch(statusFilter) {
                    case 'fully-paid':
                        filteredPayments = filteredPayments.filter(p => p.paymentPercentage === 100);
                        break;
                    case 'partial':
                        filteredPayments = filteredPayments.filter(p => p.paymentPercentage > 0 && p.paymentPercentage < 100);
                        break;
                    case 'unpaid':
                        filteredPayments = filteredPayments.filter(p => p.paymentPercentage === 0);
                        break;
                    case 'overdue':
                        filteredPayments = filteredPayments.filter(p => p.balance > 0);
                        break;
                }
            }
            
            // Filter by grade
            if (gradeFilter !== 'all') {
                filteredPayments = filteredPayments.filter(p => p.grade.toString() === gradeFilter);
            }
            
            // Update table with filtered data
            updatePaymentTable(filteredPayments);
        }

        function updatePaymentTable(payments) {
            const tbody = document.getElementById('payment-table-body');
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 50px; color: #666;">
                            🔍 No payments match the current filter criteria
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = payments.map(payment => {
                const percentage = payment.totalFees > 0 ? Math.round((payment.paidAmount / payment.totalFees) * 100) : 0;
                let statusColor = '#dc3545';
                let statusText = 'Unpaid';
                
                if (percentage === 100) {
                    statusColor = '#28a745';
                    statusText = 'Fully Paid';
                } else if (percentage > 0) {
                    statusColor = '#ffc107';
                    statusText = 'Partial';
                }

                return `
                    <tr>
                        <td>${payment.admNo}</td>
                        <td><span class="link-text" onclick="viewPaymentDetails('${payment.id}')">${payment.studentName}</span></td>
                        <td>Grade ${payment.grade}</td>
                        <td>${payment.totalFees.toFixed(2)}</td>
                        <td>${payment.paidAmount.toFixed(2)}</td>
                        <td>${payment.balance.toFixed(2)}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill ${percentage < 50 ? 'low' : percentage < 100 ? 'medium' : 'high'}" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            ${percentage}%
                        </td>
                        <td><span style="color: ${statusColor}">● ${statusText}</span></td>
                        <td>
                            <button class="btn" onclick="recordPayment('${payment.id}')">💰 Pay</button>
                            <button class="btn btn-warning" onclick="viewPaymentHistory('${payment.id}')">📋 History</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ===== FEE MANAGEMENT =====
        
        function showFeeManagement() {
            if (!checkPermission('manage_fees') && !hasPermission('all')) return;
            
            loadFeeCategories();
            showPage('fee-management-page');
        }

        function loadFeeCategoriesPage() {
            const container = document.getElementById('fee-categories-container');
            const categories = systemData.feeCategories || [];
            
            container.innerHTML = categories.map(category => `
                <div class="fee-category-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${category.name}</h4>
                            <p style="color: #666;">${category.description}</p>
                            <p><strong>Amount:</strong> ${category.amount.toFixed(2)} per term</p>
                            <p><strong>Applies to:</strong> ${category.appliesTo === 'all' ? 'All Students' : category.appliesTo}</p>
                        </div>
                        <div>
                            ${hasPermission('all') ? `
                                <button class="btn btn-warning" onclick="editFeeCategory('${category.id}')">✏️ Edit</button>
                                <button class="btn btn-danger" onclick="deleteFeeCategory('${category.i                <div class="dashboard-card role-finance" onclick="showFeeManagement()">
                    <div class="card-icon">💳</div>
                    <h3>Fee Management</h3>
                    <p>Manage fee categories</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFinancialReports()">
                    <div class="card-icon">📈</div>
                    <h3>Financial Reports</h3>
                    <p>Generate payment reports</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFeeReminders()">
                    <div class="card-icon">📧</div>
                    <h3>Fee Reminders</h3>
                    <p>Export reminder lists</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- DoS Social Affairs Dashboard -->
        <div id="dos-social-dashboard" class="page">
            <h1>👥 DoS Social Affairs Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="social-welcome"></span>!</h2>
                <p>Student Welfare and Social Activities Management</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-dos-social" onclick="showSportsManagement()">
                    <div class="card-icon">⚽</div>
                    <h3>Sports Management</h3>
                    <p>Sports fees and activities</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showUniformManagement()">
                    <div class="card-icon">👔</div>
                    <h3>Uniform Management</h3>
                    <p>Uniform fees and orders</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showStudentWelfare()">
                    <div class="card-icon">🤝</div>
                    <h3>Student Welfare</h3>
                    <p>Student support services</p>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showClubActivities()">
                    <div class="card-icon">🎭</div>
                    <h3>Club Activities</h3>
                    <p>Student clubs and societies</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- DoS Exam Dashboard -->
        <div id="dos-exam-dashboard" class="page">
            <h1>📊 DoS Examinations Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="exam-welcome"></span>!</h2>
                <p>Examination Management and Scheduling</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="upcoming-exams">0</div>
                    <div>Upcoming Exams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-exams">0</div>
                    <div>Completed Exams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-results">0</div>
                    <div>Pending Results</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-dos-exam" onclick="showExamSchedule()">
                    <div class="card-icon">📅</div>
                    <h3>Exam Schedule</h3>
                    <p>Create and manage schedules</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamCreation()">
                    <div class="card-icon">📝</div>
                    <h3>Create Exams</h3>
                    <p>Design new examinations</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showResultsManagement()">
                    <div class="card-icon">🎯</div>
                    <h3>Results Management</h3>
                    <p>Process and publish results</p>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamReports()">
                    <div class="card-icon">📈</div>
                    <h3>Exam Reports</h3>
                    <p>Generate performance reports</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="page">
            <h1>🎓 Teacher Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="teacher-welcome"></span>!</h2>
                <p>Teaching and Assessment Management</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="my-students">0</div>
                    <div>My Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="my-classes">0</div>
                    <div>Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-grades">0</div>
                    <div>Pending Grades</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-teacher" onclick="showMyStudents()">
                    <div class="card-icon">👥</div>
                    <h3>My Students</h3>
                    <p>View and manage students</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showMyExams()">
                    <div class="card-icon">📝</div>
                    <h3>My Exams</h3>
                    <p>Create and grade exams</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showRATs()">
                    <div class="card-icon">⚡</div>
                    <h3>R.A.Ts</h3>
                    <p>Random Assessment Tests</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showMyTable()">
                    <div class="card-icon">📋</div>
                    <h3>My Table</h3>
                    <p>Personal teaching schedule</p>
                </div>

                <div class="dashboard-card role-teacher" onclick="showClubManagement()">
                    <div class="card-icon">🏆</div>
                    <h3>Club Management</h3>
                    <p>Manage student clubs</p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 Profile</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Payment Dashboard -->
        <div id="payment-dashboard" class="page">
            <h1>💰 Payment Management Dashboard</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddPaymentModal()">➕ Record Payment</button>
                <button class="btn btn-warning" onclick="exportFeeReminders()">📧 Fee Reminders</button>
                <button class="btn" onclick="showPaymentReports()">📊 Reports</button>
            </div>

            <div class="filter-controls">
                <h4>🔍 Filter Students</h4>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="payment-filter" onchange="filterPayments()">
                            <option value="all">All Students</option>
                            <option value="fully-paid">Fully Paid (100%)</option>
                            <option value="partial">Partially Paid (1-99%)</option>
                            <option value="unpaid">Unpaid (0%)</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Grade</label>
                        <select id="grade-filter" onchange="filterPayments()">
                            <option value="all">All Grades</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Term</label>
                        <select id="term-filter" onchange="filterPayments()">
                            <option value="current">Current Term</option>
                            <option value="1">Term 1</option>
                            <option value="2">Term 2</option>
                            <option value="3">Term 3</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Admission No.</th>
                            <th>Student Name</th>
                            <th>Grade</th>
                            <th>Total Fees</th>
                            <th>Amount Paid</th>
                            <th>Balance</th>
                            <th>Payment %</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payment-table-body">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 50px;">
                                <div class="loading"></div>
                                Loading payment data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Fee Management Page -->
        <div id="fee-management-page" class="page">
            <h1>💳 Fee Categories Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddFeeModal()" id="add-fee-btn">➕ Add Fee Category</button>
            </div>

            <div id="fee-categories-container">
                <!-- Fee categories will be loaded here -->
            </div>
        </div>

        <!-- Exam Management Page -->
        <div id="exam-management-page" class="page">
            <h1>📊 Examination Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showCreateExamModal()">➕ Create Exam</button>
                <button class="btn btn-warning" onclick="showExamScheduleModal()">📅 Schedule Exam</button>
            </div>

            <div id="exam-schedule-container">
                <!-- Exam schedules will be loaded here -->
            </div>
        </div>

        <!-- Student Management Page -->
        <div id="student-management-page" class="page">
            <h1>👥 Student Management</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="showAddStudentModal()">➕ Add Student</button>
                <button class="btn" onclick="showBulkOperations()">⚙️ Bulk Operations</button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Filter by Grade</label>
                    <select id="student-grade-filter" onchange="filterStudents()">
                        <option value="all">All Grades</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                        <option value="9">Grade 9</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Search Students</label>
                    <input type="text" id="student-search" placeholder="Search by name or admission number" onkeyup="searchStudents()">
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Admission No.</th>
                            <th>Name</th>
                            <th>Gender</th>
                            <th>Age</th>
                            <th>Grade</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 50px;">
                                <div class="loading"></div>
                                Loading students...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Teacher Table Page -->
        <div id="teacher-table-page" class="page">
            <h1>📋 My Teaching Schedule</h1>
            
            <div class="controls-bar">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">⬅️ Back</button>
                <button class="btn btn-success" onclick="editTeacherTable()">✏️ Edit Schedule</button>
                <button class="btn btn-warning" onclick="exportTeacherTable()">📥 Export</button>
            </div>

            <div class="teacher-table-card">
                <h3>📅 Weekly Schedule</h3>
                <p style="color: #666; margin-bottom: 20px;">Your personalized teaching timetable (Feature under development)</p>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>8:00-9:00</strong></td>
                                <td>Math Grade 7</td>
                                <td>Science Grade 8</td>
                                <td>Math Grade 7</td>
                                <td>Science Grade 8</td>
                                <td>Free Period</td>
                            </tr>
                            <tr>
                                <td><strong>9:00-10:00</strong></td>
                                <td>Science Grade 9</td>
                                <td>Math Grade 9</td>
                                <td>Science Grade 9</td>
                                <td>Math Grade 9</td>
                                <td>Staff Meeting</td>
                            </tr>
                            <tr>
                                <td colspan="6" style="text-align: center; color: #666; font-style: italic;">
                                    Schedule customization coming soon...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="teacher-table-card">
                <h3>📝 Quick Notes</h3>
                <textarea id="teacher-notes" rows="5" placeholder="Add personal notes about your schedule, reminders, etc."></textarea>
                <button class="btn btn-success" onclick="saveTeacherNotes()" style="margin-top: 10px;">💾 Save Notes</button>
            </div>
        </div>

        <!-- Modals -->
        
        <!-- Add Student Modal -->
        <div id="add-student-modal" class="modal">
            <div class="modal-content">
                <h2>➕ Add New Student</h2>
                <form id="add-student-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="student-name">👤 Full Name</label>
                            <input type="text" id="student-name" required placeholder="Enter student's full name">
                        </div>
                        <div class="form-group">
                            <label for="student-adm">🎯 Admission Number</label>
                            <input type="text" id="student-adm" required placeholder="Enter unique admission number">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="student-gender">⚧ Gender</label>
                            <select id="student-gender" required>
                                <option value="">Select Gender</option>
                                <option value="M">👨 Male</option>
                                <option value="F">👩 Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-age">🎂 Age</label>
                            <input type="number" id="student-age" min="10" max="20" required placeholder="Age">
                        </div>
                        <div class="form-group">
                            <label for="student-grade">🎓 Grade</label>
                            <select id="student-grade" required>
                                <option value="">Select Grade</option>
                                <option value="7">📚 Grade 7</option>
                                <option value="8">📖 Grade 8</option>
                                <option value="9">📓 Grade 9</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="student-photo">📷 Student Photo (Optional)</label>
                        <input type="file" id="student-photo" accept="image/*">
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Add Student</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-student-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-student-message"></div>
            </div>
        </div>

        <!-- Add Payment Modal -->
        <div id="add-payment-modal" class="modal">
            <div class="modal-content">
                <h2>💰 Record Payment</h2>
                <form id="add-payment-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-student">👤 Student</label>
                            <select id="payment-student" required>
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payment-term">📅 Term</label>
                            <select id="payment-term" required>
                                <option value="1">Term 1</option>
                                <option value="2">Term 2</option>
                                <option value="3">Term 3</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="fee-categories-payment">
                        <!-- Fee categories will be loaded here -->
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-date">📅 Payment Date</label>
                            <input type="date" id="payment-date" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-method">💳 Payment Method</label>
                            <select id="payment-method" required>
                                <option value="Cash">💵 Cash</option>
                                <option value="Bank Transfer">🏦 Bank Transfer</option>
                                <option value="Mobile Money">📱 Mobile Money</option>
                                <option value="Cheque">📝 Cheque</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payment-notes">📝 Notes (Optional)</label>
                        <textarea id="payment-notes" rows="3" placeholder="Additional payment details"></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">💾 Record Payment</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-payment-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-payment-message"></div>
            </div>
        </div>

        <!-- Add Fee Category Modal -->
        <div id="add-fee-modal" class="modal">
            <div class="modal-content">
                <h2>💳 Add Fee Category</h2>
                <form id="add-fee-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fee-name">📝 Fee Name</label>
                            <input type="text" id="fee-name" required placeholder="e.g., Tuition Fee, Lunch Fee">
                        </div>
                        <div class="form-group">
                            <label for="fee-amount">💵 Amount per Term</label>
                            <input type="number" id="fee-amount" step="0.01" min="0" required placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fee-description">📋 Description</label>
                        <textarea id="fee-description" rows="3" placeholder="Description of this fee category"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fee-applies-to">🎯 Applies To</label>
                        <select id="fee-applies-to" required>
                            <option value="all">All Students</option>
                            <option value="grade7">Grade 7 Only</option>
                            <option value="grade8">Grade 8 Only</option>
                            <option value="grade9">Grade 9 Only</option>
                        </select>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Add Fee Category</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-fee-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="add-fee-message"></div>
            </div>
        </div>

        <!-- Create Exam Modal -->
        <div id="create-exam-modal" class="modal">
            <div class="modal-content">
                <h2>📝 Create New Exam</h2>
                <form id="create-exam-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-name">📋 Exam Name</label>
                            <input type="text" id="exam-name" required placeholder="e.g., Mid-term Exam 2024">
                        </div>
                        <div class="form-group">
                            <label for="exam-type">📊 Exam Type</label>
                            <select id="exam-type" required>
                                <option value="">Select Type</option>
                                <option value="Main Exam">📝 Main Exam</option>
                                <option value="R.A.T">⚡ R.A.T (Random Assessment Test)</option>
                                <option value="Assignment">📚 Assignment</option>
                                <option value="Project">🔬 Project</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-grade">🎓 Grade</label>
                            <select id="exam-grade" required>
                                <option value="">Select Grade</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exam-subject">📚 Subject</label>
                            <select id="exam-subject" required>
                                <option value="">Select Subject</option>
                                <option value="English">English</option>
                                <option value="Kiswahili">Kiswahili</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Integrated Science">Integrated Science</option>
                                <option value="Social Studies">Social Studies</option>
                                <option value="CRE">C.R.E</option>
                                <option value="Pre-technical Studies">Pre-technical Studies</option>
                                <option value="Agriculture">Agriculture</option>
                                <option value="Creative Arts">Creative Arts</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-date">📅 Exam Date</label>
                            <input type="date" id="exam-date" required>
                        </div>
                        <div class="form-group">
                            <label for="exam-duration">⏰ Duration (minutes)</label>
                            <input type="number" id="exam-duration" min="30" max="180" required placeholder="60">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="exam-instructions">📝 Instructions</label>
                        <textarea id="exam-instructions" rows="4" placeholder="Exam instructions for students"></textarea>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">✅ Create Exam</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('create-exam-modal')">❌ Cancel</button>
                    </div>
                </form>
                <div id="create-exam-message"></div>
            </div>
        </div>

    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let systemData = {
            users: [],
            students: [],
            payments: [],
            exams: [],
            feeCategories: [
                { id: 'tuition', name: 'Tuition Fee', amount: 500, description: 'Main academic fee', appliesTo: 'all' },
                { id: 'lunch', name: 'Lunch Fee', amount: 150, description: 'School meals', appliesTo: 'all' },
                { id: 'transport', name: 'Transport Fee', amount: 100, description: 'School bus service', appliesTo: 'all' },
                { id: 'sports', name: 'Sports Fee', amount: 50, description: 'Sports activities and equipment', appliesTo: 'all' },
                { id: 'uniform', name: 'Uniform Fee', amount: 80, description: 'School uniform cost', appliesTo: 'all' },
                { id: 'library', name: 'Library Fee', amount: 30, description: 'Library resources and maintenance', appliesTo: 'all' }
            ],
            settings: {
                maxAdmins: 2,
                maxDoSSocial: 2,
                maxFinance: 2,
                currentAdmins: 0,
                currentDoSSocial: 0,
                currentFinance: 0
            }
        };

        // Role limits
        const ROLE_LIMITS = {
            admin: 2,
            dos_social: 2,
            finance: 2,
            dos_exam: -1, // unlimited
            teacher: -1   // unlimited
        };

        // ===== DATA PERSISTENCE SYSTEM =====
        
        class DataManager {
            constructor() {
                this.storageKey = 'sms_advanced_v1';
                this.init();
            }

            init() {
                this.loadData();
                this.updateRoleAvailability();
                this.setupAutoSave();
            }

            loadData() {
                const stored = localStorage.getItem(this.storageKey);
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        systemData = { ...systemData, ...data };
                        this.updateRoleCounts();
                    } catch (error) {
                        console.error('Error loading data:', error);
                    }
                }
            }

            saveData() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(systemData));
                    return true;
                } catch (error) {
                    console.error('Error saving data:', error);
                    return false;
                }
            }

            setupAutoSave() {
                // Auto-save every 30 seconds
                setInterval(() => {
                    this.saveData();
                }, 30000);

                // Save on page unload
                window.addEventListener('beforeunload', () => {
                    this.saveData();
                });
            }

            updateRoleCounts() {
                const users = systemData.users || [];
                systemData.settings.currentAdmins = users.filter(u => u.role === 'admin').length;
                systemData.settings.currentDoSSoc<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System - Advanced Role-Based</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 40px;
            margin: 20px 0;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: bold;
        }

        h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 2em;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        input[type="number"], 
        input[type="file"],
        input[type="date"],
        select, 
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 18px;
            user-select: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 8px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
            color: #212529;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .role-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .role-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .role-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        }

        .role-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .role-availability {
            float: right;
            font-size: 12px;
            color: #666;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .dashboard-card:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .dashboard-card .card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .link-text {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .link-text:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        .alert {
            padding: 20px;
            margin: 25px 0;
            border-radius: 10px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-left: 5px solid #ffc107;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .page {
                padding: 25px;
            }

            .dashboard-card {
                padding: 30px 20px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 1000px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .controls-bar {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-fill.low {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .progress-fill.medium {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .progress-fill.high {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .user-role-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1001;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .filter-controls {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e1e5e9;
        }

        .fee-category-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .fee-category-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .exam-schedule-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        .teacher-table-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .role-admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .role-dos-social {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .role-finance {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .role-dos-exam {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .role-teacher {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        }

        .access-denied {
            text-align: center;
            padding: 50px;
            color: #dc3545;
        }

        .feature-unavailable {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- User Role Badge -->
    <div id="user-role-badge" class="user-role-badge" style="display: none;">
        <span id="current-role">GUEST</span>
    </div>

    <div class="container">
        <!-- Welcome Page -->
        <div id="welcome-page" class="page active">
            <h1>🏫 Advanced School Management System</h1>
            <div style="text-align: center; margin: 40px 0;">
                <h2>Role-Based Access Control System</h2>
                <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                    Secure, comprehensive, and efficient school management with specialized roles and permissions.
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">5</div>
                    <div>User Roles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">∞</div>
                    <div>Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">100%</div>
                    <div>Secure</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">24/7</div>
                    <div>Available</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="showPage('login-page')">🔑 Login</button>
                <button class="btn btn-success" onclick="showPage('signup-page')">📝 Create Account</button>
            </div>

            <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3>🎯 User Roles Available:</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>👑 Admin</strong><br>
                        <small>Complete system control (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>👥 DoS Social Affairs</strong><br>
                        <small>Student welfare & activities (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>💰 Finance</strong><br>
                        <small>Payment management (Limited: 2 users)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>📊 DoS Exam</strong><br>
                        <small>Examination management (Unlimited)</small>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <strong>🎓 Teacher</strong><br>
                        <small>Classes & assessment (Unlimited)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sign Up Page -->
        <div id="signup-page" class="page">
            <h1>📝 Create Account</h1>
            
            <form id="signup-form">
                <!-- Personal Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-fullname">👤 Full Name</label>
                        <input type="text" id="signup-fullname" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="signup-username">🆔 Username</label>
                        <input type="text" id="signup-username" required placeholder="Choose unique username">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-email">📧 Email Address</label>
                        <input type="email" id="signup-email" required placeholder="Enter email address">
                    </div>
                    <div class="form-group">
                        <label for="signup-phone">📱 Phone Number</label>
                        <input type="text" id="signup-phone" required placeholder="Enter phone number">
                    </div>
                </div>

                <!-- Role Selection -->
                <div class="form-group">
                    <label>🎭 Select Your Role</label>
                    <div id="role-selection">
                        <div class="role-card" data-role="admin">
                            <h4>👑 Administrator</h4>
                            <p>Complete system access and control. Can manage all aspects of the school system.</p>
                            <div class="role-availability">
                                <span id="admin-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="dos_social">
                            <h4>👥 DoS Social Affairs</h4>
                            <p>Manage student welfare, social activities, sports fees, and uniform costs.</p>
                            <div class="role-availability">
                                <span id="dos-social-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="finance">
                            <h4>💰 Finance Officer</h4>
                            <p>Handle all financial aspects including fee collection, payment tracking, and financial reports.</p>
                            <div class="role-availability">
                                <span id="finance-availability">Available: 2/2</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="dos_exam">
                            <h4>📊 DoS Examinations</h4>
                            <p>Manage examinations, schedules, and academic assessments.</p>
                            <div class="role-availability">
                                <span>Unlimited</span>
                            </div>
                        </div>

                        <div class="role-card" data-role="teacher">
                            <h4>🎓 Teacher</h4>
                            <p>Conduct classes, manage students, create assessments and track performance.</p>
                            <div class="role-availability">
                                <span>Unlimited</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="signup-role" required>
                </div>

                <!-- Password -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-password">🔒 Password</label>
                        <div class="password-container">
                            <input type="password" id="signup-password" required placeholder="Strong password (min 6 chars)">
                            <span class="password-toggle" onclick="togglePassword('signup-password')">👁️</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-password">🔒 Confirm Password</label>
                        <div class="password-container">
                            <input type="password" id="signup-confirm-password" required placeholder="Confirm password">
                            <span class="password-toggle" onclick="togglePassword('signup-confirm-password')">👁️</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">✨ Create Account</button>
                    <br>
                    <a href="javascript:void(0)" onclick="showPage('login-page')" class="btn btn-secondary">🔑 Login Instead</a>
                    <a href="javascript:void(0)" onclick="showPage('welcome-page')" class="btn btn-secondary">⬅️ Back</a>
                </div>
            </form>
            <div id="signup-message"></div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page">
            <h1>🔑 Login</h1>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">👤 Username or Email</label>
                    <input type="text" id="login-username" required placeholder="Enter username or email">
                </div>
                <div class="form-group">
                    <label for="login-password">🔒 Password</label>
                    <div class="password-container">
                        <input type="password" id="login-password" required placeholder="Enter password">
                        <span class="password-toggle" onclick="togglePassword('login-password')">👁️</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn">🚀 Login</button>
                    <br>
                    <a href="javascript:void(0)" onclick="forgotPassword()" class="btn btn-warning">🤔 Forgot Password?</a>
                    <a href="javascript:void(0)" onclick="showPage('signup-page')" class="btn btn-secondary">📝 Create Account</a>
                    <a href="javascript:void(0)" onclick="showPage('welcome-page')" class="btn btn-secondary">⬅️ Back</a>
                </div>
            </form>
            <div id="login-message"></div>
        </div>

        <!-- Dashboard Pages for Different Roles -->
        
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="page">
            <h1>👑 Administrator Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="admin-welcome"></span>!</h2>
                <p>You have complete administrative control over the system</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-admin" onclick="showStudentManagement()">
                    <div class="card-icon">👥</div>
                    <h3>Student Management</h3>
                    <p>Add, edit, and manage all students</p>
                    <small id="admin-student-count">0 students</small>
                </div>

                <div class="dashboard-card role-finance" onclick="showFinancialManagement()">
                    <div class="card-icon">💰</div>
                    <h3>Financial Management</h3>
                    <p>Complete payment oversight</p>
                    <small id="admin-payment-overview">Total collected: $0</small>
                </div>

                <div class="dashboard-card role-dos-exam" onclick="showExamManagement()">
                    <div class="card-icon">📊</div>
                    <h3>Exam Management</h3>
                    <p>Oversee all examinations</p>
                    <small id="admin-exam-count">0 exams scheduled</small>
                </div>

                <div class="dashboard-card role-dos-social" onclick="showSocialAffairs()">
                    <div class="card-icon">🎨</div>
                    <h3>Social Affairs</h3>
                    <p>Student welfare and activities</p>
                    <small>Sports & Uniforms</small>
                </div>

                <div class="dashboard-card role-teacher" onclick="showTeacherOverview()">
                    <div class="card-icon">🎓</div>
                    <h3>Teacher Overview</h3>
                    <p>Monitor teaching activities</p>
                    <small id="admin-teacher-count">0 active teachers</small>
                </div>

                <div class="dashboard-card" onclick="showSystemSettings()">
                    <div class="card-icon">⚙️</div>
                    <h3>System Settings</h3>
                    <p>Configure system parameters</p>
                    <small>User management & fees</small>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="showProfile()">👤 My Profile</button>
                <button class="btn btn-warning" onclick="exportSystemData()">📥 Export All Data</button>
                <button class="btn btn-danger" onclick="logout()">🚪 Logout</button>
            </div>
        </div>

        <!-- Finance Dashboard -->
        <div id="finance-dashboard" class="page">
            <h1>💰 Finance Dashboard</h1>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2>Welcome, <span id="finance-welcome"></span>!</h2>
                <p>Financial Management and Payment Tracking</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-revenue">$0</div>
                    <div>Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-payments">$0</div>
                    <div>Pending Payments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="collection-rate">0%</div>
                    <div>Collection Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overdue-accounts">0</div>
                    <div>Overdue Accounts</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card role-finance" onclick="showPaymentDashboard()">
                    <div class="card-icon">📋</div>
                    <h3>Payment Dashboard</h3>
                    <p>Track all fee payments</p>
                </div>

                <div class="dashboard-card role-finance" onclick="showFeeManagement()">
                    <div class="card-icon">💳</div>
                    <h3>Fee Management</h3>
